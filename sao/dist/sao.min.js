/*! sao-0.0.1 | GPL-3
This file is part of Tryton.  The COPYRIGHT file at the top level of
this repository contains the full copyright notices and license terms. */
var Sao={};!function(){"use strict";"contains"in String.prototype||(String.prototype.contains=function(a,b){return-1!==String.prototype.indexOf.call(this,a,b)}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){return b=b||0,this.indexOf(a,b)===b}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){b=b||this.length,b-=a.length;var c=this.lastIndexOf(a);return-1!==c&&c===b}}),Sao.error=function(a,b){alert(a+"\n"+(b||""))},Sao.warning=function(a,b){alert(a+"\n"+(b||""))},Sao.class_=function(a,b){var c=function(){if(!(this instanceof c))throw new Error("Constructor function requires new operator");this.init&&this.init.apply(this,arguments)};if(c.prototype=Object.create(a.prototype),c._super=a.prototype,b)for(var d in b)c.prototype[d]=b[d];return c},Sao.Decimal=Number,Sao.Date=function(a,b,c){var d;d=void 0===a?new Date:void 0===b?new Date(a):new Date(a,b,c),d.isDate=!0;var e=d.getDate(),f=d.getHours();return d.setHours(0),e!=d.getDate()&&(d.setDate(e),d.setHours(f)),d.setMinutes(0),d.setSeconds(0),d.setMilliseconds(0),d},Sao.DateTime=function(a,b,c,d,e,f){var g;return g=void 0===a?new Date:void 0===b?new Date(a):new Date(a,b,c,d||0,e||0,f||0),g.isDateTime=!0,g.setMilliseconds(0),g},Sao.Time=Sao.class_(Object,{init:function(a,b,c){this.date=new Date(0,0,0,a,b,c)},getHours:function(){return this.date.getHours()},setHours:function(a){this.date.setHours(a)},getMinutes:function(){return this.date.getMinutes()},setMinutes:function(a){this.date.setMinutes(a)},getSeconds:function(){return this.date.getSeconds()},setSeconds:function(a){this.date.setSeconds(a)},valueOf:function(){return this.date.valueOf()}}),Sao.config={},Sao.config.limit=1e3,Sao.config.display_size=20,Sao.login=function(){var a=jQuery.Deferred();Sao.Session.get_credentials(a),a.then(function(a){return Sao.Session.current_session=a,a.reload_context(),a}).then(function(a){Sao.rpc({method:"model.res.user.get_preferences",params:[!1,{}]},a).then(function(a){var b=[];b.push(Sao.common.MODELACCESS.load_models()),b.push(Sao.common.ICONFACTORY.load_icons()),jQuery.when.apply(jQuery,b).then(function(){Sao.menu(a),Sao.user_menu(a)})})})},Sao.logout=function(){var a=Sao.Session.current_session;jQuery("#tabs").children().remove(),jQuery("#user-preferences").children().remove(),jQuery("#user-logout").children().remove(),jQuery("#menu").children().remove(),Sao.main_menu_screen&&(Sao.main_menu_screen.save_tree_state(),Sao.main_menu_screen=null),a.do_logout(),Sao.login()},Sao.preferences=function(){jQuery("#tabs").children().remove(),jQuery("#user-preferences").children().remove(),jQuery("#user-logout").children().remove(),jQuery("#menu").children().remove(),new Sao.Window.Preferences(function(){var a=Sao.Session.current_session;a.reload_context().done(Sao.rpc({method:"model.res.user.get_preferences",params:[!1,{}]},a).then(function(a){Sao.menu(a),Sao.user_menu(a)}))})},Sao.user_menu=function(a){jQuery("#user-preferences").append(jQuery("<a/>",{href:"#"}).click(Sao.preferences).append(a.status_bar)),jQuery("#user-logout").append(jQuery("<a/>",{href:"#"}).click(Sao.logout).append("Logout"))},Sao.menu=function(a){var b=new Sao.PYSON.Decoder,c=b.decode(a.pyson_menu),d=!1;jQuery.isEmptyObject(c.views)?c.view_id&&(d=[c.view_id[0]]):d=c.views.map(function(a){return a[0]}),b=new Sao.PYSON.Decoder(Sao.Session.current_session.context);var e=b.decode(c.pyson_domain),f=new Sao.Tab.Form(c.res_model,{mode:["tree"],view_ids:d,domain:e,selection_mode:Sao.common.SELECTION_NONE});f.view_prm.done(function(){Sao.main_menu_screen=f.screen;var a=f.screen.current_view;a.table.find("th").hide(),jQuery("#menu").append(f.screen.screen_container.content_box.detach())})},Sao.main_menu_screen=null}(),function(){"use strict";Sao.rpc=function(a,b){var c=jQuery.Deferred();b||(b=new Sao.Session);var d=jQuery.extend([],a.params);d.push(jQuery.extend({},b.context,d.pop()));var e=jQuery.ajax({contentType:"application/json",data:JSON.stringify(Sao.rpc.prepareObject({method:a.method,params:[b.user_id,b.session].concat(d)})),dataType:"json",url:"/"+(b.database||""),type:"post"}),f=function(d){if(null===d)Sao.warning("Unable to reach the server"),c.reject();else if(d.error){if("UserWarning"==d.error[0]);else if("UserError"==d.error[0]);else if("ConcurrencyException"==d.error[0]);else{if("NotLogged"==d.error[0])return Sao.Session.renew(b).then(function(){Sao.rpc(a,b).then(c.resolve,c.reject)},c.reject),void 0;console.log("ERROR"),Sao.error(d.error[0],d.error[1])}c.reject()}else c.resolve(d.result)},g=function(){console.log("ERROR"),c.reject()};return e.success(f),e.error(g),c.promise()},Sao.rpc.convertJSONObject=function(a,b,c){if(a instanceof Array)for(var d=0,e=a.length;e>d;d++)Sao.rpc.convertJSONObject(a[d],d,a);else if("string"!=typeof a&&"number"!=typeof a&&null!==a)if(a&&a.__class__){switch(a.__class__){case"datetime":a=Sao.DateTime(Date.UTC(a.year,a.month-1,a.day,a.hour,a.minute,a.second));break;case"date":a=Sao.Date(a.year,a.month-1,a.day);break;case"time":a=new Sao.Time(a.hour,a.minute,a.second);break;case"buffer":for(var f=atob(a.base64.replace(/\s/g,"")),g=new ArrayBuffer(f.length),h=new Uint8Array(g),i=0;i<f.length;i++)h[i]=f.charCodeAt(i);a=h;break;case"Decimal":a=new Sao.Decimal(a.decimal)}c&&(c[b]=a)}else for(var j in a)Sao.rpc.convertJSONObject(a[j],j,a);return c||a},Sao.rpc.prepareObject=function(a,b,c){if(a instanceof Array)for(var d=0,e=a.length;e>d;d++)Sao.rpc.prepareObject(a[d],d,a);else if("string"!=typeof a&&"number"!=typeof a&&null!==a)if(a instanceof Date)a=a.isDate?{__class__:"date",year:a.getFullYear(),month:a.getMonth()+1,day:a.getDate()}:{__class__:"datetime",year:a.getUTCFullYear(),month:a.getUTCMonth()+1,day:a.getUTCDate(),hour:a.getUTCHours(),minute:a.getUTCMinutes(),second:a.getUTCSeconds()},c&&(c[b]=a);else if(a instanceof Sao.Time)a={__class__:"time",hour:a.getHours(),minute:a.getMinutes(),second:a.getSeconds()};else if(a instanceof Sao.Decimal)a={__class__:"Decimal",decimal:a.valueOf()},c&&(c[b]=a);else if(a instanceof Uint8Array)a={__class__:"buffer",base64:btoa(String.fromCharCode.apply(null,a))},c&&(c[b]=a);else for(var f in a)Sao.rpc.prepareObject(a[f],f,a);return c||a},jQuery.ajaxSetup({converters:{"text json":function(a){return Sao.rpc.convertJSONObject(jQuery.parseJSON(a))}}})}(),function(){"use strict";Sao.PYSON={},Sao.PYSON.PYSON=Sao.class_(Object,{init:function(){},pyson:function(){throw"NotImplementedError"},types:function(){throw"NotImplementedError"}}),Sao.PYSON.PYSON.eval_=function(){throw"NotImplementedError"},Sao.PYSON.Encoder=Sao.class_(Object,{encode:function(a){return JSON.stringify(a,function(a,b){return b instanceof Sao.PYSON.PYSON?b.pyson():b instanceof Date?b.isDate?Sao.PYSON.Date(b.getFullYear(),b.getMonth(),b.getDate()).pyson():Sao.PYSON.DateTime(b.getFullYear(),b.getMonth(),b.getDate(),b.getHours(),b.getMinutes(),b.getSeconds(),b.getMilliseconds()).pyson():b})}}),Sao.PYSON.Decoder=Sao.class_(Object,{init:function(a){this.__context=a||{}},decode:function(a){var b=function(a,b){if("object"==typeof b&&null!==b){var c=Sao.PYSON[b.__class__];if(c)return c.eval_(b,this.__context)}return b};return JSON.parse(a,b.bind(this))}}),Sao.PYSON.Eval=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b){void 0===b&&(b=""),Sao.PYSON.Eval._super.init.call(this),this._value=a,this._default=b},pyson:function(){return{__class__:"Eval",v:this._value,d:this._default}},types:function(){return this._default instanceof Sao.PYSON.PYSON?this._default.types():[typeof this._default]}}),Sao.PYSON.Eval.eval_=function(a,b){return a.v in b?b[a.v]:a.d},Sao.PYSON.Not=Sao.class_(Sao.PYSON.PYSON,{init:function(a){if(Sao.PYSON.Not._super.init.call(this),a instanceof Sao.PYSON.PYSON){if(jQuery(a.types()).not(["boolean"]).length||jQuery(["boolean"]).not(a.types()).length)throw"value must be boolean"}else if("boolean"!=typeof a)throw"value must be boolean";this._value=a},pyson:function(){return{__class__:"Not",v:this._value}},types:function(){return["boolean"]}}),Sao.PYSON.Not.eval_=function(a){return!a.v},Sao.PYSON.Bool=Sao.class_(Sao.PYSON.PYSON,{init:function(a){Sao.PYSON.Bool._super.init.call(this),this._value=a},pyson:function(){return{__class__:"Bool",v:this._value}},types:function(){return["boolean"]}}),Sao.PYSON.Bool.eval_=function(a){return a.v instanceof Object?!jQuery.isEmptyObject(a.v):Boolean(a.v)},Sao.PYSON.And=Sao.class_(Sao.PYSON.PYSON,{init:function(a){Sao.PYSON.And._super.init.call(this);for(var b=0,c=a.length;c>b;b++){var d=a[b];if(d instanceof Sao.PYSON.PYSON){if(jQuery(d.types()).not(["boolean"]).length||jQuery(["boolean"]).not(d.types()).length)throw"statement must be boolean"}else if("boolean"!=typeof d)throw"statement must be boolean"}if(a.length<2)throw"must have at least 2 statements";this._statements=a},pyson:function(){return{__class__:"And",s:this._statements}},types:function(){return["boolean"]}}),Sao.PYSON.And.eval_=function(a){for(var b=!0,c=0,d=a.s.length;d>c;c++){var e=a.s[c];b=b&&e}return b},Sao.PYSON.Or=Sao.class_(Sao.PYSON.And,{pyson:function(){var a=Sao.PYSON.Or._super.pyson.call(this);return a.__class__="Or",a}}),Sao.PYSON.Or.eval_=function(a){for(var b=!1,c=0,d=a.s.length;d>c;c++){var e=a.s[c];b=b||e}return b},Sao.PYSON.Equal=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b){Sao.PYSON.Equal._super.init.call(this);var c,d;if(c=a instanceof Sao.PYSON.PYSON?a.types():[typeof a],d=b instanceof Sao.PYSON.PYSON?b.types():[typeof b],jQuery(c).not(d).length||jQuery(d).not(c).length)throw"statements must have the same type";this._statement1=a,this._statement2=b},pyson:function(){return{__class__:"Equal",s1:this._statement1,s2:this._statement2}},types:function(){return["boolean"]}}),Sao.PYSON.Equal.eval_=function(a){return a.s1==a.s2},Sao.PYSON.Greater=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b,c){Sao.PYSON.Greater._super.init.call(this);for(var d=[a,b],e=0;2>e;e++){var f=d[e];if(f instanceof Sao.PYSON.PYSON){if(jQuery(f).not(["number"]).length)throw"statement must be an integer or a float"}else if("number"!=typeof f)throw"statement must be an integer or a float"}if(void 0===c&&(c=!1),c instanceof Sao.PYSON.PYSON){if(jQuery(c.types()).not(["boolean"]).length||jQuery(["boolean"]).not(c.types()).length)throw"equal must be boolean"}else if("boolean"!=typeof c)throw"equal must be boolean";this._statement1=a,this._statement2=b,this._equal=c},pyson:function(){return{__class__:"Greater",s1:this._statement1,s2:this._statement2,e:this._equal}},types:function(){return["boolean"]}}),Sao.PYSON.Greater._convert=function(a){return a=jQuery.extend({},a),a.s1=Number(a.s1),a.s2=Number(a.s2),a},Sao.PYSON.Greater.eval_=function(a){return a=Sao.PYSON.Greater._convert(a),a.e?a.s1>=a.s2:a.s1>a.s2},Sao.PYSON.Less=Sao.class_(Sao.PYSON.Greater,{pyson:function(){var a=Sao.PYSON.Less._super.pyson.call(this);return a.__class__="Less",a}}),Sao.PYSON.Less._convert=Sao.PYSON.Greater._convert,Sao.PYSON.Less.eval_=function(a){return a=Sao.PYSON.Less._convert(a),a.e?a.s1<=a.s2:a.s1<a.s2},Sao.PYSON.If=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b,c){if(Sao.PYSON.If._super.init.call(this),a instanceof Sao.PYSON.PYSON){if(jQuery(a.types()).not(["boolean"]).length||jQuery(["boolean"]).not(a.types()).length)throw"condition must be boolean"}else if("boolean"!=typeof a)throw"condition must be boolean";var d,e;if(d=b instanceof Sao.PYSON.PYSON?b.types():[typeof b],void 0===c&&(c=null),e=c instanceof Sao.PYSON.PYSON?c.types():[typeof c],jQuery(d).not(e).length||jQuery(e).not(d).length)throw"then and else statements must be the same type";this._condition=a,this._then_statement=b,this._else_statement=c},pyson:function(){return{__class__:"If",c:this._condition,t:this._then_statement,e:this._else_statement}},types:function(){return this._then_statement instanceof Sao.PYSON.PYSON?this._then_statement.types():[typeof this._then_statement]}}),Sao.PYSON.If.eval_=function(a){return a.c?a.t:a.e},Sao.PYSON.Get=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b,c){if(Sao.PYSON.Get._super.init.call(this),void 0===c&&(c=null),a instanceof Sao.PYSON.PYSON){if(jQuery(a.types()).not(["object"]).length||jQuery(["object"]).not(a.types()).length)throw"obj must be a dict"}else if(!(a instanceof Object))throw"obj must be a dict";if(this._obj=a,b instanceof Sao.PYSON.PYSON){if(jQuery(b.types()).not(["string"]).length||jQuery(["string"]).not(b.types()).length)throw"key must be a string"}else if("string"!=typeof b)throw"key must be a string";this._key=b,this._default=c},pyson:function(){return{__class__:"Get",v:this._obj,k:this._key,d:this._default}},types:function(){return this._default instanceof Sao.PYSON.PYSON?this._default.types():[typeof this._default]}}),Sao.PYSON.Get.eval_=function(a){return a.k in a.v?a.v[a.k]:a.d},Sao.PYSON.In=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b){if(Sao.PYSON.In._super.init.call(this),a instanceof Sao.PYSON.PYSON){if(jQuery(a.types()).not(["string","number"]).length)throw"key must be a string or a number"}else if(!~["string","number"].indexOf(typeof a))throw"key must be a string or a number";if(b instanceof Sao.PYSON.PYSON){if(jQuery(b.types()).not(["object"]).length||jQuery(["object"]).not(b.types()).length)throw"obj must be a dict or a list"}else if(!(b instanceof Object))throw"obj must be a dict or a list";this._key=a,this._obj=b},pyson:function(){return{__class__:"In",k:this._key,v:this._obj}},types:function(){return["boolean"]}}),Sao.PYSON.In.eval_=function(a){return a.v.indexOf?Boolean(~a.v.indexOf(a.k)):!!a.v[a.k]},Sao.PYSON.Date=Sao.class_(Sao.PYSON.PYSON,{init:function(a,b,c,d,e,f){Sao.PYSON.Date._super.init.call(this),void 0===a&&(a=null),void 0===b&&(b=null),void 0===c&&(c=null),void 0===d&&(d=0),void 0===e&&(e=0),void 0===f&&(f=0),this._test(a,"year"),this._test(b,"month"),this._test(c,"day"),this._test(d,"delta_years"),this._test(f,"delta_days"),this._test(e,"delta_months"),this._year=a,this._month=b,this._day=c,this._delta_years=d,this._delta_months=e,this._delta_days=f},pyson:function(){return{__class__:"Date",y:this._year,M:this._month,d:this._day,dy:this._delta_years,dM:this._delta_months,dd:this._delta_days}},types:function(){return["object"]},_test:function(a,b){if(a instanceof Sao.PYSON.PYSON){if(jQuery(a.types()).not(["number","object"]).length)throw b+" must be an integer or None"}else if("number"!=typeof a&&null!==a)throw b+" must be an integer or None"}}),Sao.PYSON.Date.eval_=function(a){var b=Sao.Date();b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),a.y&&b.setFullYear(a.y),a.M&&b.setMonth(a.M-1),a.d&&b.setDate(a.d);var c=b.getFullYear(),d=b.getMonth(),e=b.getDate();return a.dy&&b.setFullYear(c+a.dy),a.dM&&b.setMonth(d+a.dM),a.dd&&b.setDate(e+a.dd),b},Sao.PYSON.DateTime=Sao.class_(Sao.PYSON.Date,{init:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){Sao.PYSON.DateTime._super.init.call(this,a,b,c,h,i,j),void 0===d&&(d=null),void 0===e&&(e=null),void 0===f&&(f=null),void 0===g&&(g=null),void 0===k&&(k=0),void 0===l&&(l=0),void 0===m&&(m=0),void 0===n&&(n=0),this._test(d,"hour"),this._test(e,"minute"),this._test(f,"second"),this._test(g,"microsecond"),this._test(k,"delta_hours"),this._test(l,"delta_minutes"),this._test(m,"delta_seconds"),this._test(n,"delta_microseconds"),this._hour=d,this._minute=e,this._second=f,this._microsecond=g,this._delta_hours=k,this._delta_minutes=l,this._delta_seconds=m,this._delta_microseconds=n},pyson:function(){var a=Sao.PYSON.DateTime._super.pyson.call(this);return a.__class__="DateTime",a.h=this._hour,a.m=this._minute,a.s=this._second,a.ms=this._microsecond,a.dh=this._delta_hours,a.dm=this._delta_minutes,a.ds=this._delta_seconds,a.dms=this._delta_microseconds,a}}),Sao.PYSON.DateTime.eval_=function(a){var b=Sao.DateTime();a.y&&b.setFullYear(a.y),a.M&&b.setMonth(a.M-1),a.d&&b.setDate(a.d),void 0!==a.h&&b.setHours(a.h),void 0!==a.m&&b.setMinutes(a.m),void 0!==a.s&&b.setSeconds(a.s),void 0!==a.ms&&b.setMilliseconds(a.ms/100);var c=b.getFullYear(),d=b.getMonth(),e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds(),i=b.getMilliseconds();return a.dy&&b.setFullYear(c+a.dy),a.dM&&b.setMonth(d+a.dM),a.dd&&b.setDate(e+a.dd),a.dh&&b.setHours(f+a.dh),a.dm&&b.setMinutes(g+a.dm),a.ds&&b.setSeconds(h+a.ds),a.dms&&b.setMilliseconds(i+a.dms/100),b}}(),function(){"use strict";Sao.parse_cookie=function(){for(var a={},b=document.cookie.split("; "),c=0,d=b.length;d>c;c++){var e=b[c].split("=");2==e.length&&(a[e[0]]=e[1])}return a},Sao.set_cookie=function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];document.cookie=b+"="+c}},Sao.Session=Sao.class_(Object,{init:function(a,b){if(this.user_id=null,this.session=null,a||b)this.database=a,this.login=b;else{var c=Sao.parse_cookie();this.database=c.database,this.login=c.login}this.context={},Sao.Session.current_session||(Sao.Session.current_session=this)},do_login:function(a,b){var c=jQuery.Deferred(),d={method:"common.db.login",params:[a,b]},e=jQuery.ajax({contentType:"application/json",data:JSON.stringify(d),dataType:"json",url:"/"+this.database,type:"post"}),f=function(a){null===a?(Sao.warning("Unable to reach the server"),c.reject()):a.error?(console.log("ERROR"),Sao.error(a.error[0],a.error[1]),c.reject()):(a.result?(this.user_id=a.result[0],this.session=a.result[1],Sao.set_cookie({login:this.login,database:this.database})):(this.user_id=null,this.session=null),c.resolve())};return e.success(f.bind(this)),e.error(c.reject),c.promise()},do_logout:function(){if(this.user_id&&this.session){var a={method:"common.db.logout",params:[]},b=Sao.rpc(a,this);return this.database=null,this.login=null,this.user_id=null,this.session=null,b}},reload_context:function(){var a={method:"model.res.user.get_preferences",params:[!0,{}]},b=Sao.rpc(a,this);return b.then(function(a){this.context=a}.bind(this))}}),Sao.Session.get_credentials=function(a){var b,c,d,e,f=Sao.parse_cookie(),g=f.login,h=window.location.hash.replace(/^(#(!|))/,"")||null,i=function(){var f=d.val(),g=e.val(),i=h||b.val();if(f&&g){var j=new Sao.Session(i,f),k=j.do_login(f,g);k.done(function(){a.resolve(j)}),c.dialog("close")}},j=function(a){13===a.which&&i()},k=function(){jQuery.when(Sao.DB.list()).then(function(a){a.forEach(function(a){b.append(jQuery("<option/>",{value:a,text:a}))})}).then(function(){b.val(f.database)})};c=jQuery("<div/>",{"class":"login"}),h||(c.append(jQuery("<label/>",{text:"Database:"})),b=jQuery("<select/>"),c.append(b),k(),c.append(jQuery("<br/>"))),c.append(jQuery("<label/>",{text:"Login:"})),d=jQuery("<input/>",{type:"input",id:"login",val:g}),d.keydown(j),c.append(d),c.append(jQuery("<br/>")),c.append(jQuery("<label/>",{text:"Password:"})),e=jQuery("<input/>",{type:"password",id:"password"}),e.keydown(j),c.append(e),c.append(jQuery("<br/>")),c.dialog({title:"Login",modal:!0,buttons:{Cancel:function(){jQuery(this).dialog("close")},OK:i},open:function(){g?e.focus():d.focus()}})},Sao.Session.renew=function(a){var b,c,d=jQuery.Deferred(),e=function(){var e=c.val();a.do_login(a.login,e).done(function(){d.resolve()}),b.dialog("close")},f=function(a){13===a.which&&e()};return b=jQuery("<div/>",{"class":"login"}),b.append(jQuery("<label/>",{text:"Password:"})),c=jQuery("<input/>",{type:"password",id:"password"}),c.keydown(f),b.append(c),b.append(jQuery("<br/>")),b.dialog({title:"Login",modal:!0,buttons:{Cancel:function(){jQuery(this).dialog("close")},OK:e},open:function(){c.focus()}}),d.promise()},Sao.Session.current_session=null,Sao.DB={},Sao.DB.list=function(){var a={method:"common.db.list",params:[]};return Sao.rpc(a)}}(),function(){"use strict";Sao.Model=Sao.class_(Object,{init:function(a,b){b=b||{},this.name=a,this.session=Sao.Session.current_session,this.fields={}},add_fields:function(a){for(var b in a)if(a.hasOwnProperty(b)&&!(b in this.fields)){var c=a[b],d=Sao.field.get(c.type);this.fields[b]=new d(c)}},execute:function(a,b,c){var d={method:"model."+this.name+"."+a,params:b.concat(c)};return Sao.rpc(d,this.session)},find:function(a,b,c,d,e){b||(b=0);var f=this,g=this.execute("search",[a,b,c,d],e),h=function(a){return Sao.Group(f,e,a.map(function(a){return new Sao.Record(f,a)}))};return g.pipe(h)},delete_:function(a){if(jQuery.isEmptyObject(a))return jQuery.when();{var b=a[0];b.group.root_group}a=a.filter(function(a){return a.id>=0});var c={},d=a.map(function(a){return a.id});return this.execute("delete",[d],c)},copy:function(a,b){if(jQuery.isEmptyObject(a))return jQuery.when();var c=a.map(function(a){return a.id});return this.execute("copy",[c,{}],b)}}),Sao.Group=function(a,b,c){return c.prm=jQuery.when(),c.model=a,c.context=b,c.parent=void 0,c.screens=[],c.parent_name="",c.children=[],c.child_name="",c.parent_datetime_field=void 0,c.record_removed=[],c.record_deleted=[],c.forEach(function(a,b,c){a.group=c}),c.load=function(a,b){var c,d,e=[];for(c=0,d=a.length;d>c;c++){var f=a[c],g=this.get(f);g||(g=new Sao.Record(this.model,f),g.group=this,this.push(g)),e.push(g)}var h,i=[];for(c=0,d=this.record_removed.length;d>c;c++)h=this.record_removed[c],~a.indexOf(h.id)||i.push(h);this.record_removed=i;var j=[];for(c=0,d=this.record_deleted.length;d>c;c++)h=this.record_deleted[c],~a.indexOf(h.id)||j.push(h);this.record_deleted=j,e.length&&b&&this.changed()},c.get=function(a){for(var b=0,c=this.length;c>b;b++){var d=this[b];if(d.id==a)return d}},c.new_=function(a,b){var c=new Sao.Record(this.model,b);return c.group=this,a&&c.default_get(),c},c.add=function(a,b){void 0===b&&(b=-1),a.group!=this&&(a.group=this),this.splice(b,0,a);for(var c in this.record_removed)c.id==a.id&&this.record_removed.splice(this.record_removed.indexOf(c),1);for(var d in this.record_deleted)d.id==a.id&&this.record_deleted.splice(this.record_deleted.indexOf(d),1);return a._changed.id=!0,this.changed(),a},c.remove=function(a,b,c,d){void 0===c&&(c=!0);this.indexOf(a);a.id>=0&&(b?(~this.record_deleted.indexOf(a)&&this.record_deleted.splice(this.record_deleted.indexOf(a),1),this.record_removed.push(a)):(~this.record_removed.indexOf(a)&&this.record_removed.splice(this.record_removed.indexOf(a),1),this.record_deleted.push(a))),a.group.parent&&(a.group.parent._changed.id=!0),c&&(a._changed.id=!0),(!a.group.parent||a.id<0||d)&&this._remove(a),a.group.changed(),a.group.root_group().screens.forEach(function(a){a.display()})},c._remove=function(a){var b=this.indexOf(a);this.splice(b,1)},c.unremove=function(a){this.record_removed.splice(this.record_removed.indexOf(a),1),this.record_deleted.splice(this.record_deleted.indexOf(a),1),a.group.changed(),a.group.root_group().screens.forEach(function(a){a.display()})},c.changed=function(){if(!this.parent)return jQuery.when();this.parent._changed[this.child_name]=!0;var a=jQuery.Deferred();return this.parent.model.fields[this.child_name].changed(this.parent).then(function(){this.parent.group.changed().done(a.resolve)}.bind(this)),a},c.root_group=function(){for(var a=this,b=this.parent;b;)a=b.group,b=b.parent;return a},c.save=function(){var a=[];return this.forEach(function(b){a.push(b.save())}),jQuery.isEmptyObject(this.record_deleted)||a.push(this.model.delete_(this.record_deleted)),jQuery.when.apply(jQuery,a)},c.written=function(){},c.reload=function(a){this.children.forEach(function(b){b.reload(a)}),a.forEach(function(a){var b=this.get(a);b&&jQuery.isEmptyObject(b._changed)&&(b._loaded={})}.bind(this))},c.set_parent=function(a){this.parent=a,a&&a.model_name==this.model.name&&this.parent.group.children.push(this)},c.destroy=function(){if(this.parent){var a=this.parent.group.children.indexOf(this);~a&&this.parent.group.children.splice(a,1)}this.parent=null},c.domain=function(){var a=[];if(this.screens.forEach(function(b){b.attributes.domain&&a.push(b.attributes.domain)}),this.parent&&this.child_name){var b=this.parent.model.fields[this.child_name];return[a,b.get_domain(this.parent)]}return a},c.clean4inversion=function(a){if(jQuery.isEmptyObject(a))return[];var b=new Sao.common.DomainInversion,c=a[0],d=a.slice(1);if(~["AND","OR"].indexOf(c));else if(b.is_leaf(c)){var e=c[0];e in this.model.fields&&this.model.fields[e].description.readonly&&(c=[])}else c=this.clean4inversion(c);return[c].concat(this.clean4inversion(d))},c.domain4inversion=function(){return this.__domain4inversion||(this.__domain4inversion=this.clean4inversion(this.domain())),this.__domain4inversion},c},Sao.Record=Sao.class_(Object,{id_counter:-1,init:function(a,b){this.model=a,this.group=Sao.Group(a,{},[]),this.id=b||Sao.Record.prototype.id_counter--,this._values={},this._changed={},this._loaded={},this.fields={},this._timestamp=null,this.attachment_count=-1,this.state_attrs={}},has_changed:function(){return!jQuery.isEmptyObject(this._changed)},save:function(){var a=this.get_context(),b=jQuery.when(),c=this.get();if(this.id<0){b=this.model.execute("create",[[c]],a);var d=function(a){this.id=a[0]};b.done(d.bind(this))}else jQuery.isEmptyObject(c)||(b=this.model.execute("write",[[this.id],c],a));return b.done(function(){this.reload()}.bind(this)),b},reload:function(a){return this.id<0?jQuery.when():this.validate(a)},load:function(a){var b,c,d=this;if(this.id<0||a in this._loaded)return jQuery.when();if("pending"==this.group.prm.state())return c=jQuery.Deferred(),this.group.prm.then(function(){this.load(a).then(c.resolve,c.reject)}.bind(this)),c;var e={};e[this.id]=this;var f;if("*"==a){f="eager";for(b in this.model.fields)if(this.model.fields.hasOwnProperty(b)){var g=this.model.fields[b].description.loading||"eager";if("eager"!=g){f="lazy";break}}}else f=this.model.fields[a].description.loading||"eager";var h=[];if("eager"==f)for(b in this.model.fields)this.model.fields.hasOwnProperty(b)&&"eager"==(this.model.fields[b].description.loading||"eager")&&h.push(b);else h=Object.keys(this.model.fields);h=h.filter(function(a){return!(a in d._loaded)});var i=h.slice(),j=["many2one","one2one","reference"];for(var k in h){b=h[k];var l=this.model.fields[b].description;~j.indexOf(l.type)&&i.push(b+".rec_name")}~h.indexOf("rec_name")||i.push("rec_name"),i.push("_timestamp");var m=jQuery.extend({},this.get_context());if("eager"==f){var n=Sao.config.limit;this.group.parent||(n=parseInt(n/i.length,10));var o=function(b){return!(a in b._loaded)&&b.id>=0};[[this.group,o]].forEach(function(a){var b=a[0],c=a[1],d=this.group.indexOf(this);if(~d)for(var f=b.length,g=1;Object.keys(e).length&&(d-g>=0||f>d+g)&&2*n>g;){var h;d-g>=0&&(h=b[d-g],c(h)&&(e[h.id]=h)),f>d+g&&(h=b[d+g],c(h)&&(e[h.id]=h)),g++}}.bind(this))}for(b in this.model.fields)this.model.fields.hasOwnProperty(b)&&"binary"==this.model.fields[b].description.type&&~i.indexOf(b,i)&&(m[this.model.name+"."+b]="size");c=this.model.execute("read",[Object.keys(e).map(function(a){return parseInt(a,10)}),i],m);var p=function(a){var b={};a.forEach(function(a){b[a.id]=a});for(var c in e)if(e.hasOwnProperty(c)){var d=e[c],f=b[c];if(d&&f){for(var g in this._changed)this._changed.hasOwnProperty(g)&&delete f[g];d.set(f)}}}.bind(this),q=function(){var a,b=[];for(var c in e){a={id:c};for(var d in i)a[i[d]]=null;b.push(a)}p(b)};return this.group.prm=c.then(p,q),this.group.prm},set:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];if("_timestamp"!=b)if(b in this.model.fields){if(this.model.fields[b]instanceof Sao.field.Many2One||this.model.fields[b]instanceof Sao.field.Reference){var d=b+".rec_name";a.hasOwnProperty(d)?this._values[d]=a[d]:this._values.hasOwnProperty(d)&&delete this._values[d]}this.model.fields[b].set(this,c),this._loaded[b]=!0}else"rec_name"==b&&(this._values[b]=c);else this._timestamp=c}},get:function(){var a={};for(var b in this.model.fields)if(this.model.fields.hasOwnProperty(b)){var c=this.model.fields[b];c.description.readonly||void 0===this._changed[b]&&this.id>=0||(a[b]=c.get(this))}return a},get_context:function(){return this.group.context},field_get:function(a){return this.model.fields[a].get(this)},field_set:function(a,b){this.model.fields[a].set(this,b)},field_get_client:function(a){return this.model.fields[a].get_client(this)},field_set_client:function(a,b,c){this.model.fields[a].set_client(this,b,c)},default_get:function(){var a;if(jQuery.isEmptyObject(this.model.fields))a=jQuery.when();else{a=this.model.execute("default_get",[Object.keys(this.model.fields)],this.get_context());var b=function(a){return a};a=a.pipe(b).done(this.set_default.bind(this))}return a},set_default:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];if(b in this.model.fields){if(this.model.fields[b]instanceof Sao.field.Many2One||this.model.fields[b]instanceof Sao.field.Reference){var d=b+".rec_name";a.hasOwnProperty(d)?this._values[d]=a[d]:this._values.hasOwnProperty(d)&&delete this._values[d]}this.model.fields[b].set_default(this,c),this._loaded[b]=!0}}this.validate(null,!0).then(function(){this.group.root_group().screens.forEach(function(a){a.display()})}.bind(this))},get_eval:function(){var a={};for(var b in this.model.fields)!this.model.fields.hasOwnProperty(b)&&this.id>=0||(a[b]=this.model.fields[b].get_eval(this));return a},get_on_change_value:function(){var a={};for(var b in this.model.fields)!this.model.fields.hasOwnProperty(b)&&this.id>=0||(a[b]=this.model.fields[b].get_on_change_value(this));return a},_get_on_change_args:function(a){var b={},c=Sao.common.EvalEnvironment(this,"on_change");return a.forEach(function(a){var d=c;a.split(".").forEach(function(a){void 0!==d&&(d=d[a])}),b[a]=d}),b},on_change:function(a,b){"string"==typeof b&&(b=(new Sao.PYSON.Decoder).decode(b));var c=this._get_on_change_args(b),d=this.model.execute("on_change_"+a,[c],this.get_context());return d.then(this.set_on_change.bind(this))},on_change_with:function(a){var b,c,d={},e={},f={};for(b in this.model.fields)this.model.fields.hasOwnProperty(b)&&(c=this.model.fields[b].description.on_change_with,jQuery.isEmptyObject(c)||~c.indexOf(a)&&a!=b&&(jQuery.isEmptyObject(Sao.common.intersect(Object.keys(d).sort(),c.sort()))?(d[b]=!0,e=jQuery.extend(e,this._get_on_change_args(c)),(this.model.fields[b]instanceof Sao.field.Many2One||this.model.fields[b]instanceof Sao.field.Reference)&&delete this._values[b+".rec_name"]):f[b]=!0));var g,h=[];jQuery.isEmptyObject(d)||(g=this.model.execute("on_change_with",[e,Object.keys(d)],this.get_context()),h.push(g.then(this.set_on_change.bind(this))));var i=function(a){return function(b){this.model.fields[a].set_on_change(this,b)}};for(b in f)f.hasOwnProperty(b)&&(c=this.model.fields[b].description.on_change_with,e=this._get_on_change_args(c),g=this.model.execute("on_change_with_"+b,[e],this.get_context()),h.push(g.then(i(b).bind(this))));return jQuery.when.apply(jQuery,h)},set_on_change:function(a){var b,c,d={};for(b in a)if(a.hasOwnProperty(b)&&(c=a[b],b in this.model.fields))if(this.model.fields[b]instanceof Sao.field.One2Many)d[b]=c;else{if(this.model.fields[b]instanceof Sao.field.Many2One||this.model.fields[b]instanceof Sao.field.Reference){var e=b+".rec_name";a.hasOwnProperty(e)?this._values[e]=a[e]:this._values.hasOwnProperty(e)&&delete this._values[e]}this.model.fields[b].set_on_change(this,c)}for(b in d)if(d.hasOwnProperty(b)){c=d[b];var f=this.model.fields[b];try{f.in_on_change=!0,f.set_on_change(this,c)}finally{f.in_on_change=!1}}},expr_eval:function(a){if("string"!=typeof a)return a;var b=jQuery.extend({},this.get_context());if(b.context=jQuery.extend(this.model.session.context,b),jQuery.extend(b,this.get_eval()),b.active_model=this.model.name,b.active_id=this.id,b._user=this.model.session.user_id,this.group.parent&&this.group.parent_name){var c=Sao.common.EvalEnvironment(this.group.parent);b["_parent_"+this.group.parent_name]=c}return new Sao.PYSON.Decoder(b).decode(a)},rec_name:function(){var a=this.model.execute("read",[[this.id],["rec_name"]],this.get_context());return a.then(function(a){return a[0].rec_name})},validate:function(a,b){var c=[];return void 0===a&&(a=null),(a||["*"]).forEach(function(a){c.push(this.load(a))}.bind(this)),jQuery.when.apply(jQuery,c).then(function(){var c=!0,d=[];this.group.screens.forEach(function(a){a.exclude_field&&d.push(a.exclude_field)});for(var e in this.model.fields)if(this.model.fields.hasOwnProperty(e)){var f=this.model.fields[e];
(null===a||~a.indexOf(e))&&(f.get_state_attrs(this).readonly||~d.indexOf(e)||f.validate(this,b)||(c=!1))}return c}.bind(this))},pre_validate:function(){return jQuery.when()},cancel:function(){this._loaded={},this._changed={}},get_loaded:function(a){if(!jQuery.isEmptyObject(a)){var b=!0;return a.forEach(function(a){!(a in this._loaded)|!(a in this._changed)&&(b=!1)}.bind(this)),b}return Sao.common.compare(Object.keys(this.model.fields),Object.keys(this._loaded))},deleted:function(){return Boolean(~this.group.record_deleted.indexOf(this))},removed:function(){return Boolean(~this.group.record_removed.indexOf(this))},get_attachment_count:function(a){var b=jQuery.Deferred();return this.id<0?(b.resolve(0),b):(this.attachment_count<0||a?b=Sao.rpc({method:"model.ir.attachment.search_count",params:[[["resource","=",this.model.name+","+this.id]],{}]},this.model.session):b.resolve(this.attachment_count),b)}}),Sao.field={},Sao.field.get=function(a){switch(a){case"char":return Sao.field.Char;case"selection":return Sao.field.Selection;case"datetime":return Sao.field.DateTime;case"date":return Sao.field.Date;case"time":return Sao.field.Time;case"float":return Sao.field.Float;case"numeric":return Sao.field.Numeric;case"integer":return Sao.field.Integer;case"boolean":return Sao.field.Boolean;case"many2one":return Sao.field.Many2One;case"one2one":return Sao.field.One2One;case"one2many":return Sao.field.One2Many;case"many2many":return Sao.field.Many2Many;case"reference":return Sao.field.Reference;case"binary":return Sao.field.Binary;default:return Sao.field.Char}},Sao.field.Field=Sao.class_(Object,{_default:null,init:function(a){this.description=a,this.name=a.name},set:function(a,b){a._values[this.name]=b},get:function(a){return a._values[this.name]||this._default},set_client:function(a,b,c){var d=this.get(a);this.set(a,b),d!=this.get(a)?(a._changed[this.name]=!0,this.changed(a).done(function(){a.validate(null,!0).then(function(){a.group.changed().done(function(){var b=a.group.root_group();b.screens.forEach(function(a){a.display()})})})})):c&&(a._changed[this.name]=!0,this.changed(a).done(function(){a.validate(null,!0).then(function(){var b=a.group.root_group();b.screens.forEach(function(a){a.display()})})}))},get_client:function(a){return this.get(a)},set_default:function(a,b){a._values[this.name]=b,a._changed[this.name]=!0},set_on_change:function(a,b){a._values[this.name]=b,a._changed[this.name]=!0},changed:function(a){var b=[];return this.description.on_change&&b.push(a.on_change(this.name,this.description.on_change)),b.push(a.on_change_with(this.name)),jQuery.when.apply(jQuery,b)},get_context:function(a){var b=jQuery.extend({},a.get_context());return a.group.parent&&jQuery.extend(b,a.group.parent.get_context()),b},get_domains:function(a){var b=new Sao.common.DomainInversion,c=b.domain_inversion(a.group.domain4inversion(),this.name,Sao.common.EvalEnvironment(a));"boolean"!=typeof c||c?"boolean"==typeof c&&c&&(c=[]):c=[["id","=",null]];var d=a.expr_eval(this.description.domain||[]);return[c,d]},get_domain:function(a){var b=this.get_domains(a),c=b[0],d=b[1],e=new Sao.common.DomainInversion;return[e.localize_domain(c),d]},validation_domains:function(a){var b=this.get_domains(a),c=b[0],d=b[1],e=new Sao.common.DomainInversion;return jQuery.isEmptyObject(d)?[c,c]:[c,[c,e.unlocalize_domain(d,this.name)]]},get_eval:function(a){return this.get(a)},get_on_change_value:function(a){return this.get_eval(a)},set_state:function(a,b){void 0===b&&(b=["readonly","required","invisible"]);var c=a.expr_eval(this.description.states||{});b.forEach(function(b){"readonly"==b&&this.description.readonly||(void 0!==c[b]?this.get_state_attrs(a)[b]=c[b]:void 0!==this.description[b]&&(this.get_state_attrs(a)[b]=this.description[b]))}.bind(this))},get_state_attrs:function(a){return this.name in a.state_attrs||(a.state_attrs[this.name]=jQuery.extend({},this.description)),a.state_attrs[this.name]},check_required:function(a){var b=this.get_state_attrs(a);return 1!=b.required||this.get(a)||1==b.readonly?!0:!1},validate:function(a,b){var c=!0;if(this.description.readonly)return!0;this.get_state_attrs(a).domain_readonly=!1;var d=this.validation_domains(a),e=d[0],f=d[1];if(b||(c&=this.check_required(a)),"boolean"==typeof f)c&=f;else if(Sao.common.compare(f,[["id","=",null]]))c=!1;else{var g=new Sao.common.DomainInversion;if(e instanceof Array&&1==e.length&&"="==e[0][1]){var h=e[0][0],i=e[0][2];i===!1&&(i=null);var j=!0,k=g.merge(a.group.domain()),l="AND"==k[0];if(h.contains(".")){var m=h.split(".",1)[0],n=h.split(".",1)[1],o=[];l&&e.localize_domain(k.slice(1)).forEach(function(a){o.push(a)}),"id"==n&&~o.indexOf(m)||(j=!1)}j&&(this.set_client(a,i),this.get_state_attrs(a).domain_readonly=l)}c&=g.eval_domain(f,Sao.common.EvalEnvironment(a))}return this.get_state_attrs(a).valid=c,c}}),Sao.field.Char=Sao.class_(Sao.field.Field,{_default:""}),Sao.field.Selection=Sao.class_(Sao.field.Field,{_default:null,get_client:function(a){return a._values[this.name]}}),Sao.field.DateTime=Sao.class_(Sao.field.Field,{_default:null,time_format:function(a){return a.expr_eval(this.description.format)},set_client:function(a,b,c){if(!(b instanceof Date))try{b=Sao.common.parse_datetime(Sao.common.date_format(),this.time_format(a),b)}catch(d){b=this._default}Sao.field.DateTime._super.set_client.call(this,a,b,c)},get_client:function(a){var b=Sao.field.Date._super.get_client.call(this,a);return b?Sao.common.format_datetime(Sao.common.date_format(),this.time_format(a),b):""}}),Sao.field.Date=Sao.class_(Sao.field.Field,{_default:null,set_client:function(a,b,c){if(!(b instanceof Date))try{b=Sao.Date(jQuery.datepicker.parseDate(Sao.common.date_format(),b))}catch(d){b=this._default}Sao.field.Date._super.set_client.call(this,a,b,c)},get_client:function(a){var b=Sao.field.Date._super.get_client.call(this,a);return b?jQuery.datepicker.formatDate(Sao.common.date_format(),b):""}}),Sao.field.Time=Sao.class_(Sao.field.Field,{_default:null,time_format:function(a){return a.expr_eval(this.description.format)},set_client:function(a,b,c){b instanceof Sao.Time||(b=Sao.common.parse_time(this.time_format(a),b)),Sao.field.Time._super.set_client.call(this,a,b,c)},get_client:function(a){var b=Sao.field.Time._super.get_client.call(this,a);return b?Sao.common.format_time(this.time_format(a),b):""}}),Sao.field.Number=Sao.class_(Sao.field.Field,{_default:null,get:function(a){return void 0===a._values[this.name]?this._default:a._values[this.name]},digits:function(a){var b=[],c=[16,2],d=a.expr_eval(this.description.digits||c);for(var e in d)null!==d[e]?b.push(d[e]):b.push(c[e]);return b},check_required:function(a){var b=this.get_state_attrs(a);return 1==b.required&&null===this.get(a)&&1!=b.readonly?!1:!0}}),Sao.field.Float=Sao.class_(Sao.field.Number,{set_client:function(a,b,c){"string"==typeof b&&(b=Number(b),isNaN(b)&&(b=this._default)),Sao.field.Float._super.set_client.call(this,a,b,c)},get_client:function(a){var b=a._values[this.name];if(b||0===b){var c=this.digits(a);return b.toFixed(c[1])}return""}}),Sao.field.Numeric=Sao.class_(Sao.field.Number,{set_client:function(a,b,c){"string"==typeof b&&(b=new Sao.Decimal(b),isNaN(b.valueOf())&&(b=this._default)),Sao.field.Float._super.set_client.call(this,a,b,c)},get_client:function(a){var b=a._values[this.name];if(b){var c=this.digits(a);return b.toFixed(c[1])}return""}}),Sao.field.Integer=Sao.class_(Sao.field.Number,{set_client:function(a,b,c){"string"==typeof b&&(b=parseInt(b,10),isNaN(b)&&(b=this._default)),Sao.field.Integer._super.set_client.call(this,a,b,c)},get_client:function(a){var b=a._values[this.name];return b||0===b?""+b:""},digits:function(){return[16,0]}}),Sao.field.Boolean=Sao.class_(Sao.field.Field,{_default:!1,set_client:function(a,b,c){b=Boolean(b),Sao.field.Boolean._super.set_client.call(this,a,b,c)},get:function(a){return Boolean(a._values[this.name])},get_client:function(a){return Boolean(a._values[this.name])}}),Sao.field.Many2One=Sao.class_(Sao.field.Field,{_default:null,get:function(a){var b=a._values[this.name];return void 0===b&&(b=this._default),b},get_client:function(a){var b=a._values[this.name+".rec_name"];return void 0===b&&(this.set(a,this.get(a)),b=a._values[this.name+".rec_name"]||""),b},set:function(a,b){var c=a._values[this.name+".rec_name"]||"",d=function(b){a._values[this.name+".rec_name"]=b[0].rec_name};if(!c&&b>=0&&null!==b){var e=a.model.fields[this.name].description.relation;Sao.rpc({method:"model."+e+".read",params:[[b],["rec_name"],a.get_context()]},a.model.session).done(d.bind(this))}else d.call(this,[{rec_name:c}]);a._values[this.name]=b},set_client:function(a,b,c){var d;b instanceof Array?(d=b[1],b=b[0]):d=b==this.get(a)?a._values[this.name+".rec_name"]||"":"",a._values[this.name+".rec_name"]=d,Sao.field.Many2One._super.set_client.call(this,a,b,c)},validation_domains:function(a){var b=this.get_domains(a)[0];return[b,b]},get_domain:function(a){var b=this.get_domains(a),c=b[0],d=b[1],e=new Sao.common.DomainInversion;return[e.localize_domain(e.inverse_leaf(c),this.name),d]}}),Sao.field.One2One=Sao.class_(Sao.field.Many2One,{}),Sao.field.One2Many=Sao.class_(Sao.field.Field,{init:function(a){Sao.field.One2Many._super.init.call(this,a),this.in_on_change=!1,this.context={}},_default:null,_set_value:function(a,b,c){var d;d=b instanceof Array&&!isNaN(parseInt(b[0],10))?"list ids":"list values";var e,f=a._values[this.name];void 0!==f?(e=f.model,f.destroy()):e=a.model.name==this.description.relation?a.model:new Sao.Model(this.description.relation);var g=jQuery.when();if("list values"==d&&!jQuery.isEmptyObject(b)){var h=this.get_context(a),i={};for(var j in b)if(b.hasOwnProperty(j))for(var k in j)j.hasOwnProperty(k)&&(i[k]=!0);if(!jQuery.isEmptyObject(i)){var l={method:"model."+this.description.relation+".fields_get",params:[Object.keys(i),h]};g=Sao.rpc(l,a.model.session)}}var m=function(f){var g=Sao.Group(e,this.context,[]);if(g.set_parent(a),g.parent_name=this.description.relation_field,g.child_name=this.name,jQuery.isEmptyObject(f)||g.model.add_fields(f),void 0!==a._values[this.name]){for(var h=0,i=a._values[this.name].length;i>h;h++){var j=a._values[this.name][h];j.id>=0&&g.record_deleted.push(j)}jQuery.extend(g.record_deleted,a._values[this.name].record_deleted),jQuery.extend(g.record_removed,a._values[this.name].record_removed)}if(a._values[this.name]=g,"list ids"==d)g.load(b);else for(var k in b)if(b.hasOwnProperty(k)){var l=g.new_(!1);c?(l.set_default(k),g.add(l)):(l.id*=1,l.set(k),g.push(l))}};return g.pipe(m.bind(this))},set:function(a,b){return this._set_value(a,b,!1)},get:function(a){var b=a._values[this.name];if(void 0===b)return[];for(var c=b.record_removed,d=b.record_deleted,e=[["add",[]]],f=this.description.relation_field||"",g=0,h=b.length;h>g;g++){var i=b[g];if(!~c.indexOf(i)&&!~d.indexOf(i)){var j;i.id>=0?(j=i.get(),delete j[f],i.has_changed()&&!jQuery.isEmptyObject(j)&&e.push(["write",[i.id],j]),e[0][1].push(i.id)):(j=i.get(),delete j[f],e.push(["create",j]))}}return jQuery.isEmptyObject(e[0][1])&&e.shift(),jQuery.isEmptyObject(c)||e.push(["unlink",c.map(function(a){return a.id})]),jQuery.isEmptyObject(d)||e.push(["delete",d.map(function(a){return a.id})]),e},set_client:function(){},get_client:function(a){return this._set_default_value(a),a._values[this.name]},set_default:function(a,b){var c=a._values[this.name],d=this._set_value(a,b,!0);d.done(function(){var b=a._values[this.name];c&&(c.forEach(function(a){a.id>=0&&b.record_deleted.push(a)}),b.record_deleted=b.record_deleted.concat(c.record_deleted),b.record_removed=b.record_removed.concat(c.record_removed))}.bind(this)),a._changed[this.name]=!0},set_on_change:function(a,b){if(this._set_default_value(a),b instanceof Array)return this._set_value(a,b),a._changed[this.name]=!0,a.group.changed(),void 0;var c=jQuery.when();if(b.add||b.update){var d=this.get_context(a),e=a._values[this.name].model.fields,f={};if([b.add,b.update].forEach(function(a){jQuery.isEmptyObject(a)||a.forEach(function(a){Object.keys(a).forEach(function(a){a in e||"id"==a||(f[a]=!0)})})}),jQuery.isEmptyObject(f))c.resolve({});else{var g={method:"model."+this.description.relation+".fields_get",params:[Object.keys(f),d]};c=Sao.rpc(g,a.model.session)}}var h=[],i=a._values[this.name];i.forEach(function(a){a.id||h.push(a)}),b.remove&&b.remove.forEach(function(a){var b=i.get(a);b&&h.push(b)}.bind(this)),h.forEach(function(a){i.remove(a,!1,!0,!1)}.bind(this)),(b.add||b.update)&&c.then(function(a){i.model.add_fields(a),b.add&&b.add.forEach(function(a){var b=i.new_(!1);i.add(b),b.set_on_change(a)}),b.update&&b.update.forEach(function(a){if(a.id){var b=i.get(a.id);b&&b.set_on_change(a)}})}.bind(this))},_set_default_value:function(a){if(void 0===a._values[this.name]){var b=Sao.Group(new Sao.Model(this.description.relation),this.context,[]);b.set_parent(a),b.parent_name=this.description.relation_field,b.child_name=this.name,a.model.name==this.description.relation&&(b.fields=a.model.fields),a._values[this.name]=b}},get_eval:function(a){var b=[],c=a._values[this.name];if(void 0===c)return b;for(var d=c.record_removed,e=c.record_deleted,f=0,g=a._values[this.name].length;g>f;f++){var h=c[f];~d.indexOf(h)||~e.indexOf(h)||b.push(h.id)}return b},get_on_change_value:function(a){var b=[],c=a._values[this.name];if(void 0===c)return b;for(var d=0,e=a._values[this.name].length;e>d;d++){var f=c[d];f.deleted()&&f.removed()||b.push(f.get_on_change_value())}return b},changed:function(a){return this.in_on_change?void 0:Sao.field.One2Many._super.changed.call(this,a)},get_domain:function(a){var b=this.get_domains(a),c=b[0],d=b[1],e=new Sao.common.DomainInversion;return[e.localize_domain(e.inverse_leaf(c)),d]},validation_domains:function(a){var b=this.get_domains(a)[0];return[b,b]},set_state:function(a,b){this._set_default_value(a),Sao.field.One2Many._super.set_state.call(this,a,b),a._values[this.name].readonly=this.get_state_attrs(a).readonly}}),Sao.field.Many2Many=Sao.class_(Sao.field.One2Many,{set:function(a,b){var c,d=a._values[this.name];void 0!==d?(c=d.model,d.destroy()):c=a.model.name==this.description.relation?a.model:new Sao.Model(this.description.relation),d=Sao.Group(c,this.context,[]),d.set_parent(a),d.parent_name=this.description.relation_field,d.child_name=this.name,void 0!==a._values[this.name]&&(jQuery.extend(d.record_removed,a._values[this.name]),jQuery.extend(d.record_deleted,a._values[this.name].record_deleted),jQuery.extend(d.record_removed,a._values[this.name].record_removed)),a._values[this.name]=d,d.load(b)},get_on_change_value:function(a){return this.get_eval(a)}}),Sao.field.Reference=Sao.class_(Sao.field.Field,{_default:null,get_client:function(a){if(a._values[this.name]){var b=a._values[this.name][0],c=a._values[this.name+".rec_name"]||"";return[b,c]}return null},get:function(a){return a._values[this.name]&&a._values[this.name][0]&&a._values[this.name][1]>=-1?a._values[this.name].join(","):void 0},set_client:function(a,b,c){if(b){"string"==typeof b&&(b=b.split(","));var d,e=b[0],f=b[1];f instanceof Array?(d=f[1],f=f[0]):(f&&!isNaN(parseInt(f,10))&&(f=parseInt(f,10)),d=[e,f].join(",")==this.get(a)?a._values[this.name+".rec_name"]||"":""),a._values[this.name+".rec_name"]=d,b=[e,f]}Sao.field.Reference._super.set_client.call(this,a,b,c)},set:function(a,b){if(!b)return a._values[this.name]=this._default,void 0;var c,d;"string"==typeof b?(c=b.split(",")[0],d=b.split(",")[1],d?isNaN(parseInt(d,10))||(d=parseInt(d,10)):d=null):(c=b[0],d=b[1]);var e=a._values[this.name+".rec_name"]||"",f=function(b){a._values[this.name+".rec_name"]=b}.bind(this);c&&d>=0?!e&&d>=0&&Sao.rpc({method:"model."+c+".read",params:[[d],["rec_name"],a.get_context()]},a.model.session).done(function(a){f(a[0].rec_name)}):e=c?"":d,a._values[this.name]=[c,d],f(e)}}),Sao.field.Binary=Sao.class_(Sao.field.Field,{_default:null,get_size:function(a){var b=a._values[this.name]||0;return b instanceof Uint8Array?b.length:b},get_data:function(a){var b=jQuery.when(),c=a._values[this.name]||0;if(!(c instanceof Uint8Array)){if(a.id<0)return b;var d=a.get_context();return b=a.model.execute("read",[[a.id],[this.name]],d),b.done(function(a){return a[0][this.name]}.bind(this)),b}}})}(),function(){"use strict";Sao.Tab=Sao.class_(Object,{init:function(){this.buttons={}},create_tabcontent:function(){this.el=jQuery("<div/>",{"class":this.class_});var a=this.make_title_bar();this.el.append(a);var b=this.create_toolbar();this.el.append(b)},make_title_bar:function(){var a=jQuery("<div/>",{"class":"tab-title-bar ui-widget-header ui-corner-all"}),b=this.set_menu();return a.append(b),a.append(jQuery("<button/>",{"class":"tab-title"}).button({label:this.name,text:!0,icons:{primary:"ui-icon-triangle-1-s"}}).click(function(){b.toggle().position({my:"left top",at:"left bottom",of:jQuery(this)}),window.setTimeout(function(){jQuery(document).one("click",function(){b.hide()})},0)})),this.status=jQuery("<span/>",{"class":"tab-status"}),a.append(this.status),this.info=jQuery("<span/>",{"class":"tab-info"}),a.append(this.info),a},set_menu:function(){var a=jQuery("<ul/>");return this.menu_def.forEach(function(b){var c=b[0],d=b[1],e=b[2],f=jQuery("<li/>").append(jQuery("<a/>").append(jQuery("<span/>",{"class":"ui-icon "+c})).append(d));a.append(f),f.click(function(){this[e]()}.bind(this))}.bind(this)),a.menu({}).hide().css({position:"absolute","z-index":100}),a},create_toolbar:function(){var a=jQuery("<div/>",{"class":"ui-widget-header ui-corner-all"}),b=function(b){var c=function(){this[b[4]]()},d=jQuery("<button/>").button({id:b[0],text:b[2],icons:{primary:b[1]},label:b[2]}).click(c.bind(this));a.append(d),this.buttons[b[0]]=d};return this.toolbar_def.forEach(b.bind(this)),a},close:function(){var a=jQuery("#tabs > div");this.modified_save()&&(a.tabs("remove",this.id),a.find("> ul").children().length||a.remove())}}),Sao.Tab.counter=0,Sao.Tab.create=function(a){void 0===a.context&&(a.context={});var b;b=a.model?new Sao.Tab.Form(a.model,a):new Sao.Tab.Board(a),jQuery("#tabs").children().length||jQuery("#tabs").append(jQuery("<div/>").append(jQuery("<ul/>")));var c=jQuery("#tabs > div");c.tabs(),b.id="#tab-"+Sao.Tab.counter++,c.tabs("add",b.id,b.name),c.find("> ul li").last().append(jQuery('<a href="#"><span class="ui-icon ui-icon-circle-close"></span></a>').hover(function(){jQuery(this).css("cursor","pointer")},function(){jQuery(this).css("cursor","default")}).click(function(){b.close()})),jQuery(b.id).html(b.el),c.tabs("select",b.id),jQuery(window).resize()},Sao.Tab.Form=Sao.class_(Sao.Tab,{class_:"tab-form",init:function(a,b){Sao.Tab.Form._super.init.call(this);var c=new Sao.Screen(a,b);c.tab=this,this.screen=c,this.attributes=jQuery.extend({},b),this.name=b.name,this.create_tabcontent();var d=Sao.common.MODELACCESS.get(a);[["new","create"],["save","write"]].forEach(function(a){var b=a[0],c=a[1];this.buttons[b].prop("disabled",!d[c])}.bind(this)),this.view_prm=this.screen.switch_view().done(function(){this.el.append(c.screen_container.el),c.search_filter()}.bind(this))},toolbar_def:[["new","ui-icon-document","New","Create a new record","new_"],["save","ui-icon-disk","Save","Save this record","save"],["switch","ui-icon-arrow-4-diag","Switch","Switch view","switch_"],["reload","ui-icon-refresh","Reload","Reload","reload"],["previous","ui-icon-arrowthick-1-w","Previous","Previous Record","previous"],["next","ui-icon-arrowthick-1-e","Next","Next Record","next"],["attach","ui-icon-pin-w","Attachment","Add an attachment to the record","attach"]],menu_def:[["ui-icon-document","New","new_"],["ui-icon-disk","Save","save"],["ui-icon-arrow-4-diag","Switch","switch_"],["ui-icon-refresh","Reload/Undo","reload"],["ui-icon-copy","Duplicate","copy"],["ui-icon-trash","Delete","delete_"],["ui-icon-arrowthick-1-w","Previous","previous"],["ui-icon-arrowthick-1-e","Next","next"],["ui-icon-search","Search","search"],["ui-icon-clock","View Logs","logs"],["ui-icon-circle-close","Close Tab","close"],["ui-icon-pin-w","Attachment","attach"],["ui-icon-gear","Action","action"],["ui-icon-arrowreturn-1-e","Relate","relate"],["ui-icon-print","Print","print"]],create_toolbar:function(){var a=Sao.Tab.Form._super.create_toolbar.call(this),b=this.screen,c=this.buttons,d=b.model.execute("view_toolbar_get",[],b.context);return d.done(function(d){[["action","ui-icon-gear","Action","Launch action"],["relate","ui-icon-arrowreturn-1-e","Relate","Open related records"],["print","ui-icon-print","Print","Print report"]].forEach(function(e){var f=jQuery("<button/>").button({id:e[0],text:!0,icons:{primary:e[1],secondary:"ui-icon-triangle-1-s"},label:e[2]});c[e[0]]=f,a.append(f);var g=jQuery("<ul/>");f.click(function(){g.toggle().position({my:"left top",at:"left bottom",of:f}),window.setTimeout(function(){jQuery(document).one("click",function(){g.hide()})},0)}),d[e[0]].forEach(function(a){var c=jQuery("<li/>").append(jQuery("<a/>").append(a.name));g.append(c),c.click(function(){var c=jQuery.extend({},a);c=Sao.Action.evaluate(c,e[0],b.current_record);var d={model:b.model_name,id:b.get_id(),ids:[b.get_id()]};Sao.Action.exec_action(c,d,b.context)})}),g.menu({}).hide().css({position:"absolute","z-index":100}),a.append(g)})}),a},modified_save:function(){return this.screen.save_tree_state(),this.screen.current_view.set_value(),this.screen.modified()?!1:!0},new_:function(){Sao.common.MODELACCESS.get(this.screen.model_name).create&&this.modified_save()&&this.screen.new_()},save:function(){return Sao.common.MODELACCESS.get(this.screen.model_name).write?this.screen.save_current()?!0:!1:void 0},switch_:function(){this.screen.switch_view()},reload:function(a){a&&this.screen.modified(),this.screen.cancel_current().done(function(){this.screen.save_tree_state(!1),"form"!=this.screen.current_view.view_type&&this.screen.search_filter(),this.screen.display()}.bind(this))},copy:function(){Sao.common.MODELACCESS.get(this.screen.model_name).create&&this.modified_save()&&this.screen.copy()},delete_:function(){Sao.common.MODELACCESS.get(this.screen.model_name)["delete"]&&this.screen.remove(!0,!1,!0).done(function(){})},previous:function(){this.modified_save()&&this.screen.display_previous()},next:function(){this.modified_save()&&this.screen.display_next()},search:function(){var a=this.screen.screen_container.search_entry;a.is(":visible")&&window.setTimeout(function(){a.focus()},0)},logs:function(){var a=this.screen.current_record;if(a&&!(a.id<0)){var b=[["id","ID:"],["create_uid.rec_name","Creation User:"],["create_date","Creation Date:"],["write_uid.rec_name","Latest Modification by:"],["write_date","Latest Modification Date:"]];this.screen.model.execute("read",[[a.id],b.map(function(a){return a[0]})],this.screen.context).then(function(a){a=a[0];var c="";b.forEach(function(b){var d=b[0],e=b[1],f=a[d]||"/";a[d]&&~["create_date","write_date"].indexOf(d)&&(f=Sao.common.format_datetime(Sao.common.date_format(),"%H:%M:%S",f)),c+=e+" "+f+"\n"}),c+="Model: "+this.screen.model.name,Sao.common.message.run(c)}.bind(this))}},attach:function(){var a=this.screen.current_record;!a||a.id<0||new Sao.Window.Attachment(a,function(){this.update_attachment_count(!0)}.bind(this))},update_attachment_count:function(a){var b=this.screen.current_record;b?b.get_attachment_count(a).always(this.attachment_count.bind(this)):this.attachment_count(0)},attachment_count:function(a){var b="Attachment("+a+")";this.buttons.attach.button("option","label",b),a?this.buttons.attach.button("option","icons",{primary:"ui-icon-pin-s"}):this.buttons.attach.button("option","icons",{primary:"ui-icon-pin-w"});var c=this.screen.get_id();this.buttons.attach.prop("disabled",0>c||null===c)},action:function(){this.buttons.action.click()},relate:function(){this.buttons.relate.click()},print:function(){this.buttons.print.click()}})}(),function(){"use strict";Sao.ScreenContainer=Sao.class_(Object,{init:function(a){this.alternate_viewport=jQuery("<div/>",{"class":"screen-container"}),this.alternate_view=!1,this.tab_domain=a||[],this.el=jQuery("<div/>",{"class":"screen-container"}),this.filter_box=jQuery("<table/>",{"class":"filter-box"});var b=jQuery("<tr/>");this.filter_box.append(b),this.el.append(this.filter_box),this.filter_button=jQuery("<button/>").button({disabled:!0,label:"Filters"}),b.append(jQuery("<td/>").append(this.filter_button)),this.search_entry=jQuery("<input/>"),this.search_entry.keypress(function(a){return 13==a.which?(this.do_search(),!1):void 0}.bind(this)),b.append(jQuery("<td/>").append(this.search_entry)),this.but_bookmark=jQuery("<button/>").button({disabled:!0,label:"Bookmark"}),b.append(jQuery("<td/>").append(this.but_bookmark)),this.but_prev=jQuery("<button/>").button({label:"Previous"}),this.but_prev.click(this.search_prev.bind(this)),b.append(jQuery("<td/>").append(this.but_prev)),this.but_next=jQuery("<button/>").button({label:"Next"}),this.but_next.click(this.search_next.bind(this)),b.append(jQuery("<td/>").append(this.but_next)),this.content_box=jQuery("<div/>",{"class":"content-box"}),jQuery.isEmptyObject(this.tab_domain)?(this.tab=null,this.el.append(this.content_box)):(this.tab=jQuery("<div/>",{"class":"tab-domain"}).append(jQuery("<div/>").append(jQuery("<ul/>"))),this.tab.tabs(),this.tab_domain.forEach(function(a,b){var c=a[0];this.tab.tabs("add","#"+b,c)}.bind(this)),this.tab.find("#0").append(this.content_box),this.tab.tabs("select","#0"),this.tab.tabs({activate:this.switch_page.bind(this)}),this.el.append(this.tab))},set_text:function(a){this.search_entry.val(a)},search_prev:function(){this.screen.search_prev(this.search_entry.val())},search_next:function(){this.screen.search_next(this.search_entry.val())},switch_page:function(a,b){b.newPanel.append(b.oldPanel.children().detach()),this.do_search()},get_tab_domain:function(){return this.tab?this.tab_domain[this.tab.tabs("option","active")][1]:[]},do_search:function(){this.screen.search_filter(this.search_entry.val())},set_screen:function(a){this.screen=a},show_filter:function(){this.filter_box.show(),this.tab&&(this.tab.show(),this.content_box.detach(),this.tab.find("#"+this.tab.tabs("option","active")).append(this.content_box))},hide_filter:function(){this.filter_box.hide(),this.tab&&(this.tab.hide(),this.content_box.detach(),this.el.append(this.content_box))},set:function(a){this.alternate_view?(this.alternate_viewport.children().detach(),this.alternate_viewport.append(a)):(this.content_box.children().detach(),this.content_box.append(a))}}),Sao.Screen=Sao.class_(Object,{init:function(a,b){this.model_name=a,this.model=new Sao.Model(a,b),this.attributes=jQuery.extend({},b),this.attributes.limit=this.attributes.limit||Sao.config.limit,this.view_ids=jQuery.extend([],b.view_ids),this.view_to_load=jQuery.extend([],b.mode||["tree","form"]),this.views=[],this.exclude_field=b.exclude_field,this.context=b.context||{},this.new_group(),this.current_view=null,this.current_record=null,this.domain=b.domain||null,this.limit=b.limit||Sao.config.limit,this.offset=0,this.search_count=0,this.screen_container=new Sao.ScreenContainer(b.tab_domain),this.parent=null,this.row_activate=b.row_activate?b.row_activate:this.default_row_activate,this.tree_states={},this.fields_view_tree=null,this.domain_parser=null,this.tab=null},load_next_view:function(){if(!jQuery.isEmptyObject(this.view_to_load)){var a;jQuery.isEmptyObject(this.view_ids)||(a=this.view_ids.shift());var b=this.view_to_load.shift();return this.add_view_id(a,b)}return jQuery.when()},add_view_id:function(a,b){var c=this.model.execute("fields_view_get",[a,b],this.context);return c.pipe(this.add_view.bind(this))},add_view:function(a){var b=a.arch,c=a.fields,d=jQuery(jQuery.parseXML(b));"tree"==d.children().prop("tagName")&&(this.fields_view_tree=a);var e="eager";"form"==d.children().prop("tagName")&&(e="lazy");for(var f in c)c[f].loading=f in this.model.fields&&"eager"!=e?this.model.fields[f].description.loading:e;this.model.add_fields(c);var g=Sao.View.parse(this,d,a.field_childs);return this.views.push(g),g},number_of_views:function(){return this.views.length+this.view_to_load.length},switch_view:function(a){if(!a||!this.current_view||this.current_view.view_type!=a)for(var b=function(){return this.current_view=this.views[this.views.length-1],this.switch_view(a)}.bind(this),c=0;c<this.number_of_views();c++){if(this.view_to_load.length)return a||(a=this.view_to_load[0]),this.load_next_view().pipe(b);if(this.current_view=this.views[(this.views.indexOf(this.current_view)+1)%this.views.length],!a)break;if(this.current_view.view_type==a)break}return this.screen_container.set(this.current_view.el),this.display(),jQuery.when()},search_filter:function(a){var b=[];this.domain_parser&&!this.parent?(b=a||""===a?this.domain_parser.parse(a):this.attributes.search_value,this.screen_container.set_text(this.domain_parser.string(b))):b=[["id","in",this.group.map(function(a){return a.id})]],b=!jQuery.isEmptyObject(b)&&this.attributes.domain?["AND",b,this.attributes.domain]:this.attributes.domain||[];var c=this.screen_container.get_tab_domain();jQuery.isEmptyObject(c)||(b=["AND",b,c]);var d=this.model.find(b,this.offset,this.limit,this.attributes.order,this.context),e=this.model.execute("search_count",[b],this.context);return e.done(function(a){this.search_count=a}.bind(this)),d.done(this.set_group.bind(this)),d.done(this.display.bind(this)),jQuery.when(d,e).done(function(a,b){this.screen_container.but_next.button("option","disabled",!(a.length==this.limit&&b>this.limit+this.offset))}.bind(this)),this.screen_container.but_prev.button("option","disabled",this.offset<=0),d},set_group:function(a){this.group&&(jQuery.extend(a.model.fields,this.group.model.fields),this.group.screens.splice(this.group.screens.indexOf(this),1)),a.screens.push(this),this.group=a,this.model=a.model,jQuery.isEmptyObject(a)?this.set_current_record(null):this.set_current_record(a[0])},new_group:function(a){var b=new Sao.Group(this.model,this.context,[]);a&&b.load(a),this.set_group(b)},set_current_record:function(a){this.current_record=a,this.tab&&(a?a.get_attachment_count().always(this.tab.attachment_count.bind(this.tab)):this.tab.attachment_count(0))},display:function(){if(this.views){this.search_active(~["tree","graph","calendar"].indexOf(this.current_view.view_type));for(var a=0;a<this.views.length;a++)this.views[a]&&this.views[a].display()}this.set_tree_state()},display_next:function(){var a=this.current_view;if(a.set_value(),~["tree","form"].indexOf(a.view_type)&&this.current_record&&this.current_record.group){for(var b=this.current_record.group,c=this.current_record;b;){var d=b.indexOf(c);if(d<b.length-1){c=b[d+1];break}if(!b.parent)break;c=b.parent,b=b.parent.group}this.set_current_record(c)}else this.set_current_record(this.group[0]);a.display()},display_previous:function(){var a=this.current_view;if(a.set_value(),~["tree","form"].indexOf(a.view_type)&&this.current_record&&this.current_record.group){for(var b=this.current_record.group,c=this.current_record;b;){var d=b.indexOf(c);if(d>0){c=b[d-1];break}if(!b.parent)break;c=b.parent,b=b.parent.group}this.set_current_record(c)}else this.set_current_record(this.group[0]);a.display()},default_row_activate:function(){"tree"==this.current_view.view_type&&this.current_view.keyword_open?Sao.Action.exec_keyword("tree_open",{model:this.model_name,id:this.get_id(),ids:[this.get_id()]},jQuery.extend({},this.context)):this.switch_view("form")},get_id:function(){return this.current_record?this.current_record.id:void 0},new_:function(a){void 0===a&&(a=!0);var b=jQuery.when();this.current_view&&("tree"==this.current_view.view_type&&!this.current_view.editable||"graph"==this.current_view.view_type)&&(b=this.switch_view("form")),b.done(function(){var b;b=this.current_record?this.current_record.group:this.group;var c=b.new_(a);b.add(c,this.new_model_position()),this.set_current_record(c),this.display()}.bind(this))},new_model_position:function(){var a=-1;return a},cancel_current:function(){var a=[];return this.current_record&&(this.current_record.cancel(),this.current_record.id<0&&a.push(this.remove())),jQuery.when.apply(jQuery,a)},save_current:function(){if(!this.current_record){if("tree"!=this.current_view.view_type||jQuery.isEmptyObject(this.group))return!0;
this.set_current_record(this.group[0])}this.current_view.set_value();var a=this.current_view.get_fields(),b=jQuery.Deferred();return"tree"==this.current_view.view_type?b=this.group.save():this.current_record.validate(a).then(function(a){a?this.current_record.save().then(b.resolve,b.reject):(this.current_view.display(),b.reject())}.bind(this)),b.always(function(){this.display()}.bind(this)),b},modified:function(){var a=function(a){return a.has_changed()||a.id<0};if("tree"!=this.current_view.view_type){if(this.current_record&&a(this.current_record))return!0}else if(this.group.some(a))return!0;return!1},unremove:function(){var a=this.current_view.selected_records();a.forEach(function(a){a.group.unremove(a)})},remove:function(a,b,c){var d=null;if("form"==this.current_view.view_type&&this.current_record?d=[this.current_record]:"tree"==this.current_view.view_type&&(d=this.current_view.selected_records()),!jQuery.isEmptyObject(d)){var e=jQuery.when();return a&&(e=this.model.delete_(d)),e.then(function(){d.forEach(function(a){a.group.remove(a,b,!0,c)});var e=[];return a&&d.forEach(function(a){a.group.parent&&e.push(a.group.parent.save()),~a.group.record_deleted.indexOf(a)&&a.group.record_deleted.splice(a.group.record_deleted.indexOf(a),1),~a.group.record_removed.indexOf(a)&&a.group.record_removed.splice(a.group.record_removed.indexOf(a),1)}),this.set_current_record(null),jQuery.when.apply(jQuery,e).then(function(){this.display()}.bind(this))}.bind(this))}},copy:function(){var a=this.current_view.selected_records();return this.model.copy(a,this.context).then(function(a){this.group.load(a),jQuery.isEmptyObject(a)||this.set_current_record(this.group.get(a[0])),this.display()}.bind(this))},search_active:function(a){if(a&&!this.group.parent){if(!this.fields_view_tree)return this.model.execute("fields_view_get",[!1,"tree"],this.context).then(function(b){this.fields_view_tree=b,this.search_active(a)}.bind(this)),void 0;if(!this.domain_parser){var b=jQuery.extend({},this.fields_view_tree.fields),c=function(a){return function(b){a.selection=b}};for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];("selection"==e.type||"reference"==e.type)&&(e.selection instanceof Array||this.get_selection(e).then(c))}var f=jQuery(jQuery.parseXML(this.fields_view_tree.arch)),g=f.find("tree").children().filter(function(a){return"field"==a.tagName}).map(function(a){return a.getAttribute("name")}),h={};g.each(function(a){h[a]=b[a]}),[["id","ID","integer"],["create_uid","Creation User","many2one"],["create_date","Creation Date","datetime"],["write_uid","Modification User","many2one"],["write_date","Modification Date","datetime"]].forEach(function(a){var c=a[0],d=a[1],e=a[2];c in b||(b[c]={string:d,name:c,type:e},"datetime"==e&&(b[c].format='"%H:%M:%S"'))}),"id"in b||(b.id={string:"ID",name:"id",type:"integer"}),this.domain_parser=new Sao.common.DomainParser(b)}this.screen_container.set_screen(this),this.screen_container.show_filter()}else this.screen_container.hide_filter()},get_selection:function(a){var b,c=a.selection_change_with;if(c){var d={};c.forEach(function(a){d[a]=null}),b=this.model.execute(a.selection,[d])}else b=this.model.execute(a.selection,[]);return b.then(function(a){return a.sort(function(a,b){return a[1].localeCompare(b[1])})})},search_prev:function(a){this.offset-=this.limit,this.search_filter(a)},search_next:function(a){this.offset+=this.limit,this.search_filter(a)},get:function(){return this.current_record?(this.current_view.set_value(),this.current_record.get()):null},get_on_change_value:function(){return this.current_record?(this.current_view.set_value(),this.current_record.get_on_change_value()):null},reload:function(a,b){this.group.reload(a),b&&this.group.written(a),this.parent&&this.parent.reload(),this.display()},button:function(a){var b=this.current_record;b.save().done(function(){var c=b.get_context();b.model.execute(a.name,[[b.id]],c).then(function(a){a&&Sao.Action.execute(a,{model:this.model_name,id:b.id,ids:[b.id]},null,c),this.reload([b.id],!0)}.bind(this),function(){this.reload([b.id],!0)}.bind(this))}.bind(this))},save_tree_state:function(a){a=void 0===a?!0:a;var b,c,d,e,f,g;for(b=0,c=this.views.length;c>b;b++)if(d=this.views[b],"form"==d.view_type){for(var h in d.widgets)if(d.widgets.hasOwnProperty(h))for(e=d.widgets[h],f=0,g=e.length;g>f;f++)e[f].screen&&e[f].screen.save_tree_state(a)}else if("tree"==d.view_type&&d.children_field){var i,j,k,l;i=this.parent?this.parent.id:null,j=d.get_expanded_paths(),k=d.get_selected_paths(),i in this.tree_states||(this.tree_states[i]={}),this.tree_states[i][d.children_field]=[j,k],a&&(l=new Sao.Model("ir.ui.view_tree_state"),l.execute("set",[this.model_name,this.get_tree_domain(i),d.children_field,JSON.stringify(j),JSON.stringify(k)],{}))}},get_tree_domain:function(a){var b;return b=a?this.domain.concat([[this.exclude_field,"=",a]]):this.domain,JSON.stringify(Sao.rpc.prepareObject(b))},set_tree_state:function(){var a,b,c,d,e=this.current_view;e&&"tree"==e.view_type&&this.group&&(a=this.parent?this.parent.id:null,a in this.tree_states||(this.tree_states[a]={}),b=this.tree_states[a][e.children_field],void 0===b?(d=new Sao.Model("ir.ui.view_tree_state"),c=d.execute("get",[this.model_name,this.get_tree_domain(a),e.children_field],{})):c=jQuery.when(b),c.done(function(b){var c,d;this.tree_states[a][e.children_field]=b,c=JSON.parse(b[0]),d=JSON.parse(b[1]),e.display(d,c)}.bind(this)))}})}(),function(){"use strict";Sao.View=Sao.class_(Object,{init:function(a){this.screen=a,this.view_type=null,this.el=null,this.fields={}},set_value:function(){},get_fields:function(){return Object.keys(this.fields)}}),Sao.View.idpath2path=function(a,b){var c,d=[];if(!b)return[];for(var e=0,f=a.rows.length;f>e;e++)if(a.rows[e].record.id==b[0]){d.push(e),c=Sao.View.idpath2path(a.rows[e],b.slice(1,b.length)),d=d.concat(c);break}return d},Sao.View.parse=function(a,b,c){switch(b.children().prop("tagName")){case"tree":return new Sao.View.Tree(a,b,c);case"form":return new Sao.View.Form(a,b)}},Sao.View.tree_column_get=function(a){switch(a){case"char":return Sao.View.Tree.CharColumn;case"many2one":return Sao.View.Tree.Many2OneColumn;case"date":return Sao.View.Tree.DateColumn;case"datetime":return Sao.View.Tree.DateTimeColumn;case"time":return Sao.View.Tree.TimeColumn;case"one2many":return Sao.View.Tree.One2ManyColumn;case"many2many":return Sao.View.Tree.Many2ManyColumn;case"selection":return Sao.View.Tree.SelectionColumn;case"reference":return Sao.View.Tree.ReferenceColumn;case"float":case"numeric":return Sao.View.Tree.FloatColumn;case"float_time":return Sao.View.Tree.FloatTimeColumn;case"integer":case"biginteger":return Sao.View.Tree.IntegerColumn;case"boolean":return Sao.View.Tree.BooleanColumn;default:return Sao.View.Tree.CharColumn}},Sao.View.Tree=Sao.class_(Sao.View,{init:function(a,b,c){Sao.View.Tree._super.init.call(this,a,b),this.view_type="tree",this.selection_mode=a.attributes.selection_mode||Sao.common.SELECTION_SINGLE,this.el=jQuery("<div/>",{"class":"treeview"}),this.expanded={},this.children_field=c,this.keyword_open=b.children()[0].getAttribute("keyword_open"),this.columns=[],this.create_columns(a.model,b),this.rows=[],this.table=jQuery("<table/>",{"class":"tree"}),this.el.append(this.table);var d=jQuery("<thead/>");this.table.append(d);var e=jQuery("<tr/>");if(this.selection_mode!=Sao.common.SELECTION_NONE){var f=jQuery("<th/>");this.selection=jQuery("<input/>",{type:"checkbox","class":"selection"}),this.selection.change(this.selection_changed.bind(this)),f.append(this.selection),e.append(f)}d.append(e),this.columns.forEach(function(a){f=jQuery("<th/>",{text:a.attributes.string}),a.attributes.tree_invisible&&f.hide(),e.append(f)}),this.tbody=jQuery("<tbody/>"),this.table.append(this.tbody);var g=jQuery("<div/>",{"class":"treefooter"});this.more=jQuery("<button/>").button({label:"More"}).click(function(){this.display_size+=Sao.config.display_size,this.display()}.bind(this)),g.append(this.more),this.display_size=Sao.config.display_size,this.el.append(g)},create_columns:function(a,b){b.find("tree").children().each(function(b,c){for(var d,e,f={},g=0,h=c.attributes.length;h>g;g++)e=c.attributes[g],f[e.name]=e.value;if(["readonly","tree_invisible","expand","completion"].forEach(function(a){f[a]&&(f[a]=1==f[a])}),"field"==c.tagName){var i=c.getAttribute("name");if(i==this.screen.exclude_field)return;f.widget||(f.widget=a.fields[i].description.type);var j=["relation","domain","selection","relation_field","string","views","invisible","add_remove","sort","context","filename"];for(g in j){var k=j[g];k in a.fields[i].description&&null===c.getAttribute(k)&&(f[k]=a.fields[i].description[k])}var l=Sao.View.tree_column_get(f.widget);d=new l(a,f);"icon"in f&&d.prefixes.push(new Sao.View.Tree.Affix(this,f));var m,n,o=c.childNodes;for(g=0;g<o.length;g++){for(m=o[g],n={},g=0,h=m.attributes.length;h>g;g++)e=m.attributes[g],n[e.name]=e.value;"prefix"==m.tagName?d.prefixes.push(new Sao.View.Tree.Affix(i,n)):d.suffixes.push(new Sao.View.Tree.Affix(i,n))}this.fields[i]=!0}else"button"==c.tagName&&(d=new Sao.View.Tree.ButtonColumn(this.screen,f));this.columns.push(d)}.bind(this))},display:function(a,b){a=a||this.get_selected_paths(),b=b||[];var c=this.screen.current_record;c&&!Sao.common.contains(a,[[c.id]])&&(a=[[c.id]]),this.rows=[],this.tbody.empty();var d=function(c,d){var e=new Sao.View.Tree.Row(this,c,d);this.rows.push(e),e.display(a,b)};this.screen.group.slice(0,this.display_size).forEach(d.bind(this)),this.display_size>=this.screen.group.length?this.more.hide():this.more.show()},switch_:function(){this.screen.row_activate()},select_changed:function(a){this.screen.set_current_record(a)},selected_records:function(){if(this.selection_mode==Sao.common.SELECTION_NONE)return[];var a=[],b=function(c){c.is_selected()&&a.push(c.record),c.rows.forEach(b)};return this.rows.forEach(b),this.selection.prop("checked")&&!this.selection.prop("indeterminate")&&this.screen.group.slice(this.rows.length).forEach(function(b){a.push(b)}),a},selection_changed:function(){var a=this.selection.prop("checked"),b=function(c){c.set_selection(a),c.rows.forEach(b)};this.rows.forEach(b),a&&this.rows[0]?this.select_changed(this.rows[0].record):this.select_changed(null)},update_selection:function(){if(!this.selection.prop("checked")){var a=this.selected_records();this.selection.prop("indeterminate",!1),jQuery.isEmptyObject(a)?this.selection.prop("checked",!1):a.length==this.tbody.children().length&&this.display_size>=this.screen.group.length?this.selection.prop("checked",!0):(this.selection.prop("indeterminate",!0),this.selection.prop("checked",!0))}},get_selected_paths:function(){function a(c,d){var e,f,g,h;for(e=0,g=c.rows.length;g>e;e++)f=c.rows[e],h=d.concat([f.record.id]),f.is_selected()&&b.push(h),a(f,h)}var b=[];return a(this,[]),b},get_expanded_paths:function(a,b){var c,d,e,f,g;void 0===a&&(a=[]),void 0===b&&(b=[]),d=[],e=this.find_row(a),f=e?e.rows:this.rows;for(var h=0,i=this.n_children(e);i>h;h++)g=a.concat([h]),e=f[h],e.is_expanded()&&(c=b.concat(e.record.id),d.push(c),d=d.concat(this.get_expanded_paths(g,c)));return d},find_row:function(a){for(var b,c=null,d=this.rows,e=0,f=a.length;f>e;e++){if(b=a[e],!d||b>=d.length)return null;if(c=d[b],d=c.rows,!this.children_field)break}return c},n_children:function(a){return a&&this.children_field?a.record._values[this.children_field].length:this.rows.length}}),Sao.View.Tree.Row=Sao.class_(Object,{init:function(a,b,c,d){this.tree=a,this.rows=[],this.record=b,this.parent_=d,this.children_field=a.children_field,this.expander=null;var e=[];if(d&&(e=jQuery.extend([],d.path.split("."))),e.push(c),this.path=e.join("."),this.el=jQuery("<tr/>"),this.tree.selection_mode!=Sao.common.SELECTION_NONE){var f=jQuery("<td/>");this.el.append(f),this.selection=jQuery("<input/>",{type:"checkbox","class":"selection"}),this.selection.change(this.selection_changed.bind(this)),f.append(this.selection)}},is_expanded:function(){return this.path in this.tree.expanded},get_last_child:function(){return this.children_field&&this.is_expanded()&&!jQuery.isEmptyObject(this.rows)?this.rows[this.rows.length-1].get_last_child():this},get_id_path:function(){return this.parent_?this.parent_.get_id_path().concat([this.record.id]):[this.record.id]},display:function(a,b){a=a||[],b=b||[];for(var c=this.path.split(".").length,d=function(){jQuery.isEmptyObject(this.record.field_get(this.children_field))&&this.expander.css("background","none")},e=function(a){this.select_row(a)},f=0;f<this.tree.columns.length;f++){var g=jQuery("<td/>");g.click(e.bind(this));var h=jQuery("<table/>");h.css("width","100%"),g.append(h);var i=jQuery("<tr/>");if(h.append(i),0===f&&this.children_field){var j="ui-icon-plus";(this.is_expanded()||~b.indexOf(this.record.id))&&(j="ui-icon-minus"),this.expander=jQuery("<span/>",{"class":"ui-icon "+j}),this.expander.html("&nbsp;"),this.expander.css("margin-left",c-1+"em"),this.expander.css("float","left"),this.expander.click(this.toggle_row.bind(this)),i.append(jQuery("<td/>").append(this.expander).css("width",1)),this.record.load(this.children_field).done(d.bind(this))}var k,l=this.tree.columns[f];for(k=0;k<l.prefixes.length;k++){var m=l.prefixes[k];i.append(jQuery("<td/>").append(m.render(this.record)).css("width",1))}for(i.append(jQuery("<td/>").append(l.render(this.record))),k=0;k<l.suffixes.length;k++){var n=l.suffixes[k];i.append(jQuery("<td/>").append(n.render(this.record)).css("width",1))}l.attributes.tree_invisible&&g.hide(),this.el.append(g)}var o=this.get_id_path();if(this.set_selection(Sao.common.contains(a,o)),this.parent_){var p=this.parent_.get_last_child();p.el.after(this.el)}else this.tree.tbody.append(this.el);if(this.is_expanded()||Sao.common.contains(b,o)){this.tree.expanded[this.path]=this;var q=function(){var c=function(c,d){var e=new Sao.View.Tree.Row(this.tree,c,d,this);e.display(a,b),this.rows.push(e)},d=this.record.field_get_client(this.children_field);d.forEach(c.bind(this))};this.record.load(this.children_field).done(q.bind(this))}this.record.deleted()||this.record.removed()?this.el.css("text-decoration","line-through"):this.el.css("text-decoration","inherit")},toggle_row:function(){this.is_expanded()?(this.expander.removeClass("ui-icon-minus"),this.expander.addClass("ui-icon-plus"),delete this.tree.expanded[this.path]):(this.expander.removeClass("ui-icon-plus"),this.expander.addClass("ui-icon-minus"),this.tree.expanded[this.path]=this),this.tree.display()},select_row:function(a){if(this.tree.selection_mode==Sao.common.SELECTION_NONE)this.tree.select_changed(this.record),this.tree.switch_(this.path);else{if(!a.ctrlKey&&(this.tree.rows.forEach(function(a){a!=this&&a.set_selection(!1)}.bind(this)),this.selection_changed(),this.is_selected()))return this.tree.switch_(this.path),void 0;this.set_selection(!this.is_selected()),this.selection_changed()}},is_selected:function(){return this.tree.selection_mode==Sao.common.SELECTION_NONE?!1:this.selection.prop("checked")},set_selection:function(a){this.tree.selection_mode!=Sao.common.SELECTION_NONE&&(this.selection.prop("checked",a),a||this.tree.selection.prop("checked",!1))},selection_changed:function(){var a=this.is_selected();this.set_selection(a),a?this.tree.select_changed(this.record):this.tree.select_changed(this.tree.selected_records()[0]||null),this.tree.update_selection()}}),Sao.View.Tree.Affix=Sao.class_(Object,{init:function(a,b,c){this.name=b.name||a,this.attributes=b,this.protocol=c||null,this.icon=b.icon,this.protocol&&!this.icon&&(this.icon="tryton-web-browser")},get_cell:function(){var a;return this.protocol?(a=jQuery("<a/>"),a.append(jQuery("<img/>"))):a=this.icon?jQuery("<img/>"):jQuery("<span/>"),a.addClass("column-affix"),a},render:function(a){var b=this.get_cell();return a.load(this.name).done(function(){var c,d,e=a.model.fields[this.name];if(this.icon){if(this.icon in a.model.fields){var f=a.model.fields[this.icon];c=f.get_client(a)}else c=this.icon;d=Sao.common.ICONFACTORY.register_icon(c),d.done(function(a){var c;c=b.children("img").length?b.children("img"):b,c.attr("src",a)}.bind(this))}else c=this.attributes.string||"",c||(c=e.get_client(a)||""),b.text(c)}.bind(this)),b}}),Sao.View.Tree.CharColumn=Sao.class_(Object,{class_:"column-char",init:function(a,b){this.type="field",this.model=a,this.field=a.fields[b.name],this.attributes=b,this.prefixes=[],this.suffixes=[]},get_cell:function(){var a=jQuery("<div/>");return a.addClass(this.class_),a},update_text:function(a,b){a.text(this.field.get_client(b))},render:function(a){var b=this.get_cell();return a.load(this.attributes.name).done(function(){this.update_text(b,a),this.field.set_state(a);var c=this.field.get_state_attrs(a);c.invisible?b.hide():b.show()}.bind(this)),b}}),Sao.View.Tree.IntegerColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-integer",get_cell:function(){var a=Sao.View.Tree.IntegerColumn._super.get_cell.call(this);return a.css("text-align","right"),a}}),Sao.View.Tree.FloatColumn=Sao.class_(Sao.View.Tree.IntegerColumn,{class_:"column-float"}),Sao.View.Tree.BooleanColumn=Sao.class_(Sao.View.Tree.IntegerColumn,{class_:"column-boolean",get_cell:function(){return jQuery("<input/>",{type:"checkbox",disabled:!0,"class":this.class_})},update_text:function(a,b){a.prop("checked",this.field.get(b))}}),Sao.View.Tree.Many2OneColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-many2one"}),Sao.View.Tree.SelectionColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-selection",init:function(a,b){Sao.View.Tree.SelectionColumn._super.init.call(this,a,b),Sao.common.selection_mixin.init.call(this),this.init_selection()},init_selection:function(a){Sao.common.selection_mixin.init_selection.call(this,a)},update_selection:function(a,b){Sao.common.selection_mixin.update_selection.call(this,a,this.field,b)},update_text:function(a,b){this.update_selection(b,function(){for(var c,d,e=this.field.get(b),f=!1,g=0,h=this.selection.length;h>g;g++)if(this.selection[g][0]===e){f=!0,d=this.selection[g][1];break}c=f?jQuery.when(d):Sao.common.selection_mixin.get_inactive_selection.call(this,e).then(function(a){return a[1]}),c.done(function(b){a.text(b)}.bind(this))}.bind(this))}}),Sao.View.Tree.ReferenceColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-reference",init:function(a,b){Sao.View.Tree.ReferenceColumn._super.init.call(this,a,b),Sao.common.selection_mixin.init.call(this),this.init_selection()},init_selection:function(a){Sao.common.selection_mixin.init_selection.call(this,a)},update_text:function(a,b){var c,d,e=this.field.get_client(b);e?(c=e[0],d=e[1]):(c="",d=""),c?a.text(this.selection[c]||c+","+d):a.text(d)}}),Sao.View.Tree.DateColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-date"}),Sao.View.Tree.DateTimeColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-datetime"}),Sao.View.Tree.TimeColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-time"}),Sao.View.Tree.One2ManyColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-one2many",update_text:function(a,b){a.text("( "+this.field.get_client(b).length+" )")}}),Sao.View.Tree.Many2ManyColumn=Sao.class_(Sao.View.Tree.One2ManyColumn,{class_:"column-many2many"}),Sao.View.Tree.FloatTimeColumn=Sao.class_(Sao.View.Tree.CharColumn,{class_:"column-float_time",init:function(a,b){Sao.View.Tree.FloatTimeColumn._super.init.call(this,a,b),this.conv=null},update_text:function(a,b){a.text(Sao.common.text_to_float_time(this.field.get_client(b),this.conv))}}),Sao.View.Tree.ButtonColumn=Sao.class_(Object,{init:function(a,b){this.screen=a,this.type="button",this.attributes=b},render:function(a){var b=new Sao.common.Button(this.attributes);b.el.click(a,this.button_clicked.bind(this));var c=jQuery.map(this.screen.model.fields,function(a,b){return"eager"==(a.description.loading||"eager")?b:void 0});return a.load(c[0]).done(function(){b.set_state(a)}),b.el},button_clicked:function(a){var b=a.data;b==this.screen.current_record&&this.screen.button(this.attributes)}}),Sao.View.Form=Sao.class_(Sao.View,{init:function(a,b){Sao.View.Form._super.init.call(this,a,b),this.view_type="form",this.el=jQuery("<div/>",{"class":"form"}),this.widgets={},this.widget_id=0,this.state_widgets=[],this.containers=[];var c=b.children()[0],d=this.parse(a.model,c);this.el.append(d.el)},parse:function(a,b,c){void 0===c&&(c=new Sao.View.Form.Container(Number(b.getAttribute("col")||4)),this.containers.push(c));var d=function(b,d){for(var e={},f=0,g=d.attributes.length;g>f;f++){var h=d.attributes[f];e[h.name]=h.value}switch(["readonly","invisible"].forEach(function(a){e[a]&&(e[a]=1==e[a])}),["yexpand","yfill","xexpand","xfill","colspan"].forEach(function(a){e[a]&&(e[a]=Number(e[a]))}),d.tagName){case"image":break;case"separator":this._parse_separator(a,d,c,e);break;case"label":this._parse_label(a,d,c,e);break;case"newline":c.add_row();break;case"button":this._parse_button(d,c,e);break;case"notebook":this._parse_notebook(a,d,c,e);break;case"page":this._parse_page(a,d,c,e);break;case"field":this._parse_field(a,d,c,e);break;case"group":this._parse_group(a,d,c,e);break;case"hpaned":break;case"vpaned":break;case"child":}};return jQuery(b).children().each(d.bind(this)),c},_parse_separator:function(a,b,c,d){var e=d.name,f=d.string;e in a.fields&&(!d.states&&e in a.fields&&(d.states=a.fields[e].description.states),f||(f=a.fields[e].description.string));var g=new Sao.View.Form.Separator(f,d);this.state_widgets.push(g),c.add(d,g)},_parse_label:function(a,b,c,d){var e=d.name,f=d.string;if(void 0===d.xexpand&&(d.xexpand=0),e in a.fields){if(e==this.screen.exclude_field)return c.add(d),void 0;!d.states&&e in a.fields&&(d.states=a.fields[e].description.states),f||(f=a.fields[e].description.string+":"),void 0===b.getAttribute("xalign")&&b.setAttribute("xalign",1)}var g;f&&(g=new Sao.View.Form.Label(f,d),this.state_widgets.push(g)),c.add(d,g)},_parse_button:function(a,b,c){var d=new Sao.common.Button(c);this.state_widgets.push(d),b.add(c,d),d.el.click(d,this.button_clicked.bind(this))},_parse_notebook:function(a,b,c,d){void 0===d.colspan&&(d.colspan=4);var e=new Sao.View.Form.Notebook(d);this.state_widgets.push(e),c.add(d,e),this.parse(a,b,e)},_parse_page:function(a,b,c,d){var e=d.string;d.name in a.fields&&(e||(e=a.fields[d.name].description.string)),e||(e="No String Attr.");var f=this.parse(a,b);f=new Sao.View.Form.Page(c.add(f.el,e),d),this.state_widgets.push(f)},_parse_field:function(a,b,c,d){var e=d.name;if(!(e in a.fields)||e==this.screen.exclude_field)return c.add(d),void 0;d.widget||(d.widget=a.fields[e].description.type);var f=["relation","domain","selection","relation_field","string","views","add_remove","sort","context","size","filename","autocomplete","translate","create","delete"];for(var g in f){var h=f[g];h in a.fields[e].description&&null===b.getAttribute(h)&&(d[h]=a.fields[e].description[h])}var i=Sao.View.form_widget_get(d.widget);if(!i)return c.add(d),void 0;var j=new i(e,a,d);j.position=this.widget_id+=1,j.view=this,c.add(d,j),void 0===this.widgets[e]&&(this.widgets[e]=[]),this.widgets[e].push(j),this.fields[e]=!0},_parse_group:function(a,b,c,d){var e=new Sao.View.Form.Group(d);e.add(this.parse(a,b)),this.state_widgets.push(e),c.add(d,e)},display:function(){var a,b,c=this.screen.current_record,d={};if(c){var e=[];for(b in c.model.fields)a=c.model.fields[b],e.push([b,a.description.loading||"eager"]);e.sort(function(a,b){return a[1].localeCompare(b[1])}),e.forEach(function(a){var b=a[0];d[b]=c.load(b)})}var f=function(a,b,c){var e=jQuery.when();c in d&&(e=d[c]),e.done(function(){b.set_state(a)})},g=function(a,b,c){return function(e){var f=jQuery.when();c in d&&(f=d[c]),f.done(function(){e.display(a,b)})}};for(b in this.widgets){var h=this.widgets[b];a=null,c&&(a=c.model.fields[b]),a&&f(c,a,b),h.forEach(g(c,a,b))}jQuery.when.apply(jQuery,jQuery.map(d,function(a){return a})).done(function(){var a;for(a in this.state_widgets){var b=this.state_widgets[a];b.set_state(c)}for(a in this.containers){var d=this.containers[a];d.resize()}}.bind(this))},set_value:function(){var a=this.screen.current_record;if(a){var b=function(b){b.set_value(a,this)};for(var c in this.widgets)if(c in a.model.fields){var d=this.widgets[c],e=a.model.fields[c];d.forEach(b,e)}}},button_clicked:function(a){var b=a.data,c=this.screen.current_record,d=Object.keys(this.fields);c.validate(d).then(function(a){return a?(this.screen.button(b.attributes),void 0):(this.screen.display(),void 0)}.bind(this))},selected_records:function(){return this.screen.current_record?[this.screen.current_record]:[]}}),Sao.View.Form.Container=Sao.class_(Object,{init:function(a){void 0===a&&(a=4),this.col=a,this.el=jQuery("<table/>",{"class":"form-container"}),this.add_row()},add_row:function(){this.el.append(jQuery("<tr/>"))},rows:function(){return this.el.children().children("tr")},row:function(){return this.rows().last()},add:function(a,b){var c=a.colspan;void 0===c&&(c=1);var d=a.xfill;void 0===d&&(d=1);var e=a.xexpand;void 0===e&&(e=1);var f=0,g=this.row();g.children().map(function(a,b){f+=Number(jQuery(b).attr("colspan")||1)}),f+c>this.col&&(this.add_row(),g=this.row());var h;b&&(h=b.el);var i=jQuery("<td/>",{colspan:c,"class":b?b.class_||"":""}).append(h);e&&(i.addClass("xexpand"),i.css("width","100%")),d&&(i.addClass("xfill"),e&&h&&h.css("width","100%")),g.append(i)},resize:function(){var a,b,c=this.rows().toArray(),d=[],e=this.col,f=!1,g=function(b){b=jQuery(b);var c=[];return a=0,b.children().map(function(){var b=jQuery(this),d=Math.min(Number(b.attr("colspan")),e);b.hasClass("xexpand")&&!jQuery.isEmptyObject(b.children())&&"none"!=b.children().css("display")&&c.push([b,a]),a+=d}),c};c.sort(function(a,b){if(a=g(a),b=g(b),a.length==b.length){var c=function(a,b){var c=b[0],d=Math.min(Number(c.attr("colspan")),e);return a+d};return a.reduce(c,0)-b.reduce(c,0)}return b.length-a.length}),c.forEach(function(c){c=jQuery(c);var h=g(c),i=100/h.length;h.forEach(function(c){var f=c[0];a=c[1];var g=Math.min(Number(f.attr("colspan")),e),h=0;for(b=0;g>b;b++)h+=d[a+b]||0;for(b=0;g>b;b++)if(h){if(h>i){var j=h-i;d[a+b]&&(d[a+b]-=j/(h/d[a+b]))}}else d[a+b]=i/g}),jQuery.isEmptyObject(h)||(f=!0)}),c.forEach(function(c){c=jQuery(c),a=0,c.children().map(function(){var c=jQuery(this),f=Math.min(Number(c.attr("colspan")),e);if(c.hasClass("xexpand")&&"none"!=c.children().css("display")){var g=0;for(b=0;f>b;b++)g+=d[a+b]||0;c.css("width",g+"%")}"none"==c.children().css("display")?c.hide():c.show(),a+=f})}),f?this.el.css("width","100%"):this.el.css("width","")}});var a=Sao.class_(Object,{init:function(a){this.attributes=a},set_state:function(a){var b;b=a?a.expr_eval(this.attributes.states||{}):{};var c=b.invisible;void 0===c&&(c=this.attributes.invisible),c?this.hide():this.show()},show:function(){this.el.show()},hide:function(){this.el.hide()}});Sao.View.Form.Separator=Sao.class_(a,{init:function(a,b){Sao.View.Form.Separator._super.init.call(this,b),this.el=jQuery("<div/>",{"class":"form-separator"}),a&&this.el.append(jQuery("<p/>",{text:a})),this.el.append(jQuery("<hr/>"))}}),Sao.View.Form.Label=Sao.class_(a,{class_:"form-label",init:function(a,b){Sao.View.Form.Label._super.init.call(this,b),this.el=jQuery("<label/>",{text:a,"class":this.class_})},set_state:function(a){if(Sao.View.Form.Label._super.set_state.call(this,a),void 0===this.attributes.string&&this.attributes.name){var b="";a&&(b=a.field_get_client(this.attributes.name)||""),this.el.val(b)}}}),Sao.View.Form.Notebook=Sao.class_(a,{class_:"form-notebook",init:function(a){Sao.View.Form.Notebook._super.init.call(this,a),this.el=jQuery("<div/>",{"class":this.class_}),this.el.append(jQuery("<ul/>")),this.el.tabs(),this.selected=!1,this.counter=0},add:function(a,b){var c="#tab-form-"+this.counter++;return this.el.tabs("add",c,b),this.el.children(c).html(a),this.selected||(this.el.tabs("select",c),this.selected=!0),jQuery("> ul li",this.el).last()}}),Sao.View.Form.Page=Sao.class_(a,{init:function(a,b){Sao.View.Form.Page._super.init.call(this,b),this.el=a}}),Sao.View.Form.Group=Sao.class_(a,{class_:"form-group",init:function(a){Sao.View.Form.Group._super.init.call(this,a),this.el=jQuery("<div/>",{"class":this.class_})},add:function(a){this.el.append(a.el)}}),Sao.View.form_widget_get=function(a){switch(a){case"char":return Sao.View.Form.Char;case"sha":return Sao.View.Form.Sha;case"date":return Sao.View.Form.Date;case"datetime":return Sao.View.Form.DateTime;case"integer":case"biginteger":return Sao.View.Form.Integer;case"float":case"numeric":return Sao.View.Form.Float;case"selection":return Sao.View.Form.Selection;case"float_time":return Sao.View.Form.FloatTime;case"boolean":return Sao.View.Form.Boolean;case"text":return Sao.View.Form.Text;case"many2one":return Sao.View.Form.Many2One;case"reference":return Sao.View.Form.Reference;case"one2many":return Sao.View.Form.One2Many;case"many2many":return Sao.View.Form.Many2Many;case"binary":return Sao.View.Form.Binary}},Sao.View.Form.Widget=Sao.class_(Object,{init:function(a,b,c){this.field_name=a,this.model=b,this.view=null,this.attributes=c,this.el=null,this.position=0,this.visible=!0},display:function(a,b){var c=this.attributes.readonly,d=this.attributes.invisible;if(!b)return void 0===c&&(c=!0),void 0===d&&(d=!1),this.set_readonly(c),this.set_invisible(d),void 0;var e=b.get_state_attrs(a);void 0===c&&(c=e.readonly,void 0===c&&(c=!1)),this.set_readonly(c);var f=!0;void 0!==e.valid&&(f=e.valid);var g="inherit";c||(f?e.required&&(g="lightblue"):g="red"),this.set_color(g),void 0===d&&(d=b.get_state_attrs(a).invisible,void 0===d&&(d=!1)),this.set_invisible(d)},record:function(){return this.view&&this.view.screen?this.view.screen.current_record:void 0},field:function(){var a=this.record();return a?a.model.fields[this.field_name]:void 0},focus_out:function(){this.field()&&this.visible&&this.set_value(this.record(),this.field())},set_value:function(){},set_readonly:function(a){this.el.prop("disabled",a)},_get_color_el:function(){return this.el},set_color:function(a){var b=this._get_color_el();b.css("background-color",a)},set_invisible:function(a){this.visible=!a,a?this.el.hide():this.el.show()}}),Sao.View.Form.Char=Sao.class_(Sao.View.Form.Widget,{class_:"form-char",init:function(a,b,c){Sao.View.Form.Char._super.init.call(this,a,b,c),this.el=jQuery("<input/>",{type:"input","class":this.class_}),this.el.change(this.focus_out.bind(this))},display:function(a,b){if(Sao.View.Form.Char._super.display.call(this,a,b),a){var c=a.field_get_client(this.field_name);this.el.val(c||"")}else this.el.val("")},set_value:function(a,b){b.set_client(a,this.el.val())}}),Sao.View.Form.Sha=Sao.class_(Sao.View.Form.Char,{class_:"form-sha",init:function(a,b,c){Sao.View.Form.Sha._super.init.call(this,a,b,c),this.el.prop("type","password")}}),Sao.View.Form.Date=Sao.class_(Sao.View.Form.Widget,{class_:"form-date",init:function(a,b,c){Sao.View.Form.Date._super.init.call(this,a,b,c),this.el=jQuery("<div/>",{"class":this.class_}),this.date=jQuery("<input/>",{type:"input"}),this.el.append(jQuery("<div/>").append(this.date)),this.date.datepicker({showOn:"none"}),this.date.change(this.focus_out.bind(this)),this.button=jQuery("<button/>").button({icons:{primary:"ui-icon-calendar"},text:!1}),this.el.prepend(this.button),this.button.click(function(){this.date.datepicker("show")}.bind(this))},_get_color_el:function(){return this.date},get_format:function(){return Sao.common.date_format()},display:function(a,b){a&&b&&this.date.datepicker("option","dateFormat",this.get_format(a,b)),Sao.View.Form.Date._super.display.call(this,a,b),a&&this.date.val(a.field_get_client(this.field_name))},set_value:function(a,b){b.set_client(a,this.date.val())}}),Sao.View.Form.DateTime=Sao.class_(Sao.View.Form.Date,{init:function(a,b,c){Sao.View.Form.DateTime._super.init.call(this,a,b,c),this.date.datepicker("option","beforeShow",function(){var a=" "+Sao.common.format_time(this.field().time_format(this.record()),this._get_time());this.date.datepicker("option","dateFormat",Sao.common.date_format()+a),this.date.prop("disabled",!0)}.bind(this)),this.date.datepicker("option","onClose",function(){this.date.prop("disabled",!1)
}.bind(this))},_get_time:function(){return Sao.common.parse_datetime(Sao.common.date_format(),this.field().time_format(this.record()),this.date.val())},get_format:function(a,b){var c="";if(a){var d=a.field_get(this.field_name);c=" "+Sao.common.format_time(b.time_format(a),d)}return Sao.common.date_format()+c}}),Sao.View.Form.Time=Sao.class_(Sao.View.Form.Char,{class_:"form-time"}),Sao.View.Form.Integer=Sao.class_(Sao.View.Form.Char,{class_:"form-integer",init:function(a,b,c){Sao.View.Form.Integer._super.init.call(this,a,b,c),this.el.css("text-align","right")},set_value:function(a,b){b.set_client(a,this.el.val())}}),Sao.View.Form.Float=Sao.class_(Sao.View.Form.Integer,{class_:"form-float"}),Sao.View.Form.Selection=Sao.class_(Sao.View.Form.Widget,{class_:"form-selection",init:function(a,b,c){Sao.View.Form.Selection._super.init.call(this,a,b,c),this.el=jQuery("<select/>",{"class":this.class_}),this.el.change(this.focus_out.bind(this)),Sao.common.selection_mixin.init.call(this),this.init_selection()},init_selection:function(a){Sao.common.selection_mixin.init_selection.call(this,a,this.set_selection.bind(this))},update_selection:function(a,b,c){Sao.common.selection_mixin.update_selection.call(this,a,b,function(a){this.set_selection(a),c&&c()}.bind(this))},set_selection:function(a){var b=this.el;b.empty(),a.forEach(function(a){b.append(jQuery("<option/>",{value:a[0],text:a[1]}))})},display:function(a,b){Sao.View.Form.Selection._super.display.call(this,a,b),this.update_selection(a,b,function(){if(!b)return this.el.val(""),void 0;for(var c,d=b.get(a),e=!1,f=0,g=this.selection.length;g>f;f++)if(this.selection[f][0]===d){e=!0;break}e?c=jQuery.when():(c=Sao.common.selection_mixin.get_inactive_selection.call(this,d),c.done(function(a){this.el.append(jQuery("<option/>",{value:a[0],text:a[1],disabled:!0}))}.bind(this))),c.done(function(){null===d&&(d=""),this.el.val(""+d)}.bind(this))}.bind(this))},value_get:function(){var a=this.el.val();return"relation"in this.attributes?""===a?null:(null===a&&(a=this.el.find(":selected").attr("value")),parseInt(a,10)):a},set_value:function(a,b){var c=this.value_get();b.set_client(a,c)}}),Sao.View.Form.FloatTime=Sao.class_(Sao.View.Form.Char,{class_:"form-float-time",init:function(a,b,c){Sao.View.Form.FloatTime._super.init.call(this,a,b,c),this.el.css("text-align","right"),this.conv=null},display:function(a,b){if(Sao.View.Form.FloatTime._super.display.call(this,a,b),a){var c=a.field_get_client(this.field_name);this.el.val(Sao.common.text_to_float_time(c,this.conv))}else this.el.val("")}}),Sao.View.Form.Boolean=Sao.class_(Sao.View.Form.Widget,{class_:"form-boolean",init:function(a,b,c){Sao.View.Form.Boolean._super.init.call(this,a,b,c),this.el=jQuery("<input/>",{type:"checkbox","class":this.class_}),this.el.change(this.focus_out.bind(this))},display:function(a,b){Sao.View.Form.Boolean._super.display.call(this,a,b),a?this.el.prop("checked",a.field_get(this.field_name)):this.el.prop("checked",!1)},set_value:function(a,b){var c=this.el.prop("checked");b.set_client(a,c)}}),Sao.View.Form.Text=Sao.class_(Sao.View.Form.Widget,{class_:"form-text",init:function(a,b,c){Sao.View.Form.Text._super.init.call(this,a,b,c),this.el=jQuery("<textarea/>",{"class":this.class_}),this.el.change(this.focus_out.bind(this))},display:function(a,b){if(Sao.View.Form.Text._super.display.call(this,a,b),a){var c=a.field_get_client(this.field_name);this.el.val(c)}else this.el.val("")},set_value:function(a,b){var c=this.el.val()||"";b.set_client(a,c)}}),Sao.View.Form.Many2One=Sao.class_(Sao.View.Form.Widget,{class_:"form-many2one",init:function(a,b,c){Sao.View.Form.Many2One._super.init.call(this,a,b,c),this.el=jQuery("<div/>",{"class":this.class_}),this.entry=jQuery("<input/>",{type:"input"}),this.entry.on("keyup",this.key_press.bind(this)),this.el.append(jQuery("<div/>").append(this.entry)),this.but_open=jQuery("<button/>").button({icons:{primary:"ui-icon-search"},text:!1}),this.but_open.click(this.edit.bind(this)),this.el.prepend(this.but_open),this.but_new=jQuery("<button/>").button({icons:{primary:"ui-icon-document"},text:!1}),this.but_new.click(this.new_.bind(this)),this.el.prepend(this.but_new)},_get_color_el:function(){return this.entry},get_screen:function(){var a=this.field().get_domain(this.record()),b=this.field().get_context(this.record());return new Sao.Screen(this.get_model(),{context:b,domain:a,mode:["form"],view_ids:(this.attributes.view_ids||"").split(","),views_preload:this.attributes.views})},set_text:function(a){jQuery.isEmptyObject(a)&&(a=""),this.entry.val(a)},display:function(a,b){var c;return Sao.View.Form.Many2One._super.display.call(this,a,b),this._set_button_sensitive(),a?(this.set_text(b.get_client(a)),c=b.get(a),this.has_target(c)?this.but_open.button({icons:{primary:"ui-icon-folder-open"}}):this.but_open.button({icons:{primary:"ui-icon-search"}}),void 0):(this.entry.val(""),void 0)},set_readonly:function(a){this.entry.prop("disabled",a),this._set_button_sensitive()},_set_button_sensitive:function(){var a=this.get_model(),b={create:!0,read:!0};a&&(b=Sao.common.MODELACCESS.get(a));var c=this.entry.prop("disabled"),d=this.attributes.create;void 0===d&&(d=!0),this.but_new.prop("disabled",c||!d||!b.create),this.but_open.prop("disabled",!b.read)},id_from_value:function(a){return a},value_from_id:function(a,b){return void 0===b&&(b=""),[a,b]},get_model:function(){return this.attributes.relation},has_target:function(a){return void 0!==a&&null!==a},edit:function(){var a=this.get_model();if(a&&Sao.common.MODELACCESS.get(a).read){var b,c=this.record(),d=c.field_get(this.field_name);if(a&&this.has_target(d)){var e=this.get_screen(),f=this.id_from_value(c.field_get(this.field_name));e.new_group([f]);var g=function(a){if(a){var b=e.current_record.rec_name();b.done(function(a){var b=this.value_from_id(e.current_record.id,a);this.record().field_set_client(this.field_name,b,!0)}.bind(this))}};b=new Sao.Window.Form(e,g.bind(this),{save_current:!0})}else if(a){var h,i=this.field().get_domain(c),j=this.field().get_context(c),k=this.entry.val();h=k?[["rec_name","ilike","%"+k+"%"],i]:i;var l=new Sao.Model(a),m=l.execute("search",[h,0,Sao.config.limit,null],j);m.done(function(c){if(1==c.length)return this.record().field_set_client(this.field_name,this.id_from_value(c[0]),!0),void 0;var d=function(a){if(!jQuery.isEmptyObject(a)){var b=this.value_from_id(a[0][0],a[0][1]);this.record().field_set_client(this.field_name,b,!0)}};b=new Sao.Window.Search(a,d.bind(this),{sel_multi:!1,ids:c,context:j,domain:i,view_ids:(this.attributes.view_ids||"").split(","),views_preload:this.attributes.views||{},new_:!this.but_new.prop("disabled")})}.bind(this))}}},new_:function(){var a=this.get_model();if(a&&Sao.common.MODELACCESS.get(a).create){var b=this.get_screen(),c=function(a){if(a){var c=b.current_record.rec_name();c.done(function(a){var c=this.value_from_id(b.current_record.id,a);this.record().field_set_client(this.field_name,c)}.bind(this))}};new Sao.Window.Form(b,c.bind(this),{new_:!0,save_current:!0})}},key_press:function(a){var b=!0,c=[Sao.common.TAB_KEYCODE],d=[Sao.common.BACKSPACE_KEYCODE,Sao.common.DELETE_KEYCODE];if(this.wid_completion||c.push(Sao.common.RETURN_KEYCODE),a.which==Sao.common.F3_KEYCODE&&b)this.new_(),a.preventDefault();else if(a.which==Sao.common.F2_KEYCODE)this.edit(),a.preventDefault();else if(~c.indexOf(a.which))this.activate();else if(this.has_target(this.record().field_get(this.field_name))&&b){var e=this.record().field_get_client(this.field_name);(e!=this.entry.val()||~d.indexOf(a.which))&&(this.entry.val(""),this.record().field_set_client(this.field_name,this.value_from_id(null,"")))}},activate:function(){var a=this.get_model();if(a&&Sao.common.MODELACCESS.get(a).read){var b=this.record(),c=b.field_get(this.field_name),d=new Sao.Model(a);if(a&&!this.has_target(c)){var e=this.entry.val();if(!this._readonly&&(e||this.field().get_state_attrs(this.record()).required)){var f,g=this.field().get_domain(b),h=this.field().get_context(b);f=e?[["rec_name","ilike","%"+e+"%"],g]:g;var i=d.execute("search",[f,0,Sao.config.limit,null],h);i.done(function(b){if(1==b.length)return Sao.rpc({method:"model."+a+".read",params:[[this.id_from_value(b[0])],["rec_name"],h]},this.record().model.session).then(function(a){this.record().field_set_client(this.field_name,this.value_from_id(b[0],a[0].rec_name),!0)}.bind(this)),void 0;{var c=function(a){if(jQuery.isEmptyObject(a))this.entry.val("");else{var b=this.value_from_id(a[0][0],a[0][1]);this.record().field_set_client(this.field_name,b,!0)}};new Sao.Window.Search(a,c.bind(this),{sel_multi:!1,ids:b,context:h,domain:g,view_ids:(this.attributes.view_ids||"").split(","),views_preload:this.attributes.views||{},new_:!1})}}.bind(this))}}}}}),Sao.View.Form.Reference=Sao.class_(Sao.View.Form.Many2One,{class_:"form-reference",init:function(a,b,c){Sao.View.Form.Reference._super.init.call(this,a,b,c),this.select=jQuery("<select/>"),this.el.prepend(jQuery("<span/>").text("-")),this.el.prepend(this.select),this.select.change(this.select_changed.bind(this)),Sao.common.selection_mixin.init.call(this),this.init_selection()},init_selection:function(a){Sao.common.selection_mixin.init_selection.call(this,a,this.set_selection.bind(this))},update_selection:function(a,b,c){Sao.common.selection_mixin.update_selection.call(this,a,b,function(a){this.set_selection(a),c&&c()}.bind(this))},set_selection:function(a){var b=this.select;b.empty(),a.forEach(function(a){b.append(jQuery("<option/>",{value:a[0],text:a[1]}))})},id_from_value:function(a){return parseInt(a.split(",")[1],10)},value_from_id:function(a,b){return b||(b=""),[this.get_model(),[a,b]]},get_model:function(){return this.select.val()},has_target:function(a){if(null===a)return!1;var b=a.split(",")[0];return a=a.split(",")[1],jQuery.isEmptyObject(a)?a=null:(a=parseInt(a,10),isNaN(a)&&(a=null)),b==this.get_model()&&a>=0},_set_button_sensitive:function(){Sao.View.Form.Reference._super._set_button_sensitive.call(this),this.select.prop("disabled",this.entry.prop("disabled"))},select_changed:function(){this.entry.val("");var a,b=this.get_model();a=b?[b,[-1,""]]:["",""],this.record().field_set_client(this.field_name,a)},set_value:function(a,b){var c;if(this.get_model()){c=b.get_client(a,this.field_name);var d,e;c instanceof Array?(d=c[0],e=c[1]):(d="",e=""),(d!=this.get_model()||e!=this.entry.val())&&(b.set_client(a,this.field_name,null),this.entry.val(""))}else c=this.entry.val(),jQuery.isEmptyObject(c)?b.set_client(a,this.field_name,null):b.set_client(a,this.field_name,["",c])},set_text:function(a){var b;a?(b=a[0],a=a[1]):(b=null,a=null),Sao.View.Form.Reference._super.set_text.call(this,a),b?this.select.val(b):this.select.val("")},display:function(a,b){this.update_selection(a,b,function(){Sao.View.Form.Reference._super.display.call(this,a,b)}.bind(this))}}),Sao.View.Form.One2Many=Sao.class_(Sao.View.Form.Widget,{class_:"form-one2many",init:function(a,b,c){Sao.View.Form.One2Many._super.init.call(this,a,b,c),this._readonly=!0,this.el=jQuery("<div/>",{"class":this.class_}),this.menu=jQuery("<div/>",{"class":this.class_+"-menu"}),this.el.append(this.menu);var d=jQuery("<span/>",{"class":this.class_+"-string",text:c.string});this.menu.append(d);var e=jQuery("<span/>",{"class":this.class_+"-toolbar"});this.menu.append(e),c.add_remove&&(this.wid_text=jQuery("<input/>",{type:"input"}),e.append(this.wid_text),this.but_add=jQuery("<button/>").button({icons:{primary:"ui-icon-plus"},label:"Add",text:!1}),this.but_add.click(this.add.bind(this)),e.append(this.but_add),this.but_remove=jQuery("<button/>").button({icons:{primary:"ui-icon-minus"},label:"Remove",text:!1}),this.but_remove.click(this.remove.bind(this)),e.append(this.but_remove)),this.but_new=jQuery("<button/>").button({icons:{primary:"ui-icon-document"},label:"New",text:!1}),this.but_new.click(this.new_.bind(this)),e.append(this.but_new),this.but_open=jQuery("<button/>").button({icons:{primary:"ui-icon-folder-open"},label:"Open",text:!1}),this.but_open.click(this.open.bind(this)),e.append(this.but_open),this.but_del=jQuery("<button/>").button({icons:{primary:"ui-icon-trash"},label:"Delete",text:!1}),this.but_del.click(this.delete_.bind(this)),e.append(this.but_del),this.but_undel=jQuery("<button/>").button({icons:{primary:"ui-icon-arrowreturn-1-s"},label:"Undelete",text:!1}),this.but_undel.click(this.undelete.bind(this)),e.append(this.but_undel),this.but_previous=jQuery("<button/>").button({icons:{primary:"ui-icon-arrowthick-1-w"},label:"Previous",text:!1}),this.but_previous.click(this.previous.bind(this)),e.append(this.but_previous),this.label=jQuery("<span/>",{"class":this.class_+"-label"}),this.label.text("(0, 0)"),e.append(this.label),this.but_next=jQuery("<button/>").button({icons:{primary:"ui-icon-arrowthick-1-e"},label:"Next",text:!1}),this.but_next.click(this.next.bind(this)),e.append(this.but_next),this.but_switch=jQuery("<button/>").button({icons:{primary:"ui-icon-arrow-4-diag"},label:"Switch",text:!1}),this.but_switch.click(this.switch_.bind(this)),e.append(this.but_switch),this.content=jQuery("<div/>",{"class":this.class_+"-content"}),this.el.append(this.content);var f=(c.mode||"tree,form").split(",");this.screen=new Sao.Screen(c.relation,{mode:f,view_ids:(c.view_ids||"").split(","),views_preload:c.views||{},row_activate:this.activate.bind(this),exclude_field:c.relation_field||null}),this.prm=this.screen.switch_view(f[0]).done(function(){this.content.append(this.screen.screen_container.el)}.bind(this))},_get_color_el:function(){return this.screen.current_view&&"tree"==this.screen.current_view.view_type&&this.screen.current_view.el?this.screen.current_view.el:Sao.View.Form.One2Many._super._get_color_el.call(this)},set_readonly:function(a){this._readonly=a,this._set_button_sensitive()},_set_button_sensitive:function(){var a=Sao.common.MODELACCESS.get(this.screen.model_name),b=!1;this.record()&&this.field();var c=this.attributes.create;void 0===c&&(c=!0),this.but_new.prop("disabled",this._readonly||!c||b||!a.create);var d=this.attributes["delete"];void 0===d&&(d=!0),this.but_del.prop("disabled",this._readonly||!d||!a["delete"]),this.but_undel.prop("disabled",this._readonly||b),this.but_open.prop("disabled",!a.read),this.attributes.add_remove&&(this.wid_text.prop("disabled",this._readonly),this.but_add.prop("disabled",this._readonly||b||!a.write||!a.read),this.but_remove.prop("disabled",this._readonly||!a.write||!a.read))},display:function(a,b){Sao.View.Form.One2Many._super.display.call(this,a,b),this._set_button_sensitive(),this.prm.done(function(){if(a){if(void 0===b)return this.screen.new_group(),this.screen.set_current_record(null),this.screen.parent=!0,this.screen.display(),void 0;var c=a.field_get_client(this.field_name);c!=this.screen.group&&this.screen.set_group(c),this.screen.display()}}.bind(this))},activate:function(){this.edit()},add:function(){var a=Sao.common.MODELACCESS.get(this.screen.model_name);!a.write||!a.read},remove:function(){var a=Sao.common.MODELACCESS.get(this.screen.model_name);a.write&&a.read&&this.screen.remove(!1,!0,!1)},new_:function(){Sao.common.MODELACCESS.get(this.screen.model_name).create&&this.validate().done(function(){var a=jQuery.extend({},this.field().get_context(this.record()));if("form"==this.screen.current_view.type||this.screen.current_view.editable)this.screen.new_(),this.screen.current_view.el.prop("disabled",!1);else{var b=this.record(),c=b.expr_eval(this.attributes.size)||-1;c-=this.field().get_eval(b);{new Sao.Window.Form(this.screen,function(){},{new_:!0,many:c,context:a})}}}.bind(this))},open:function(){this.edit()},delete_:function(){Sao.common.MODELACCESS.get(this.screen.model_name)["delete"]&&this.screen.remove(!1,!1,!1)},undelete:function(){this.screen.unremove()},previous:function(){this.validate().done(function(){this.screen.display_previous()}.bind(this))},next:function(){this.validate().done(function(){this.screen.display_next()}.bind(this))},switch_:function(){this.screen.switch_view()},edit:function(){Sao.common.MODELACCESS.get(this.screen.model_name).read&&this.validate().done(function(){var a=this.screen.current_record;if(a){new Sao.Window.Form(this.screen,function(){})}}.bind(this))},validate:function(){var a=jQuery.Deferred();this.view.set_value();var b=this.screen.current_record;if(b){var c=this.screen.current_view.get_fields();b.validate(c).then(function(b){b||(this.screen.display(),a.reject()),a.resolve()}.bind(this))}else a.resolve();return a},set_value:function(){this.screen.save_tree_state()}}),Sao.View.Form.Many2Many=Sao.class_(Sao.View.Form.Widget,{class_:"form-many2many",init:function(a,b,c){Sao.View.Form.Many2Many._super.init.call(this,a,b,c),this._readonly=!0,this.el=jQuery("<div/>",{"class":this.class_}),this.menu=jQuery("<div/>",{"class":this.class_+"-menu"}),this.el.append(this.menu);var d=jQuery("<span/>",{"class":this.class_+"-string",text:c.string});this.menu.append(d);var e=jQuery("<span/>",{"class":this.class_+"-toolbar"});this.menu.append(e),this.entry=jQuery("<input/>",{type:"input"}),this.entry.on("keyup",this.key_press.bind(this)),e.append(this.entry),this.but_add=jQuery("<button/>").button({icons:{primary:"ui-icon-plus"},label:"Add",text:!1}),this.but_add.click(this.add.bind(this)),e.append(this.but_add),this.but_remove=jQuery("<button/>").button({icons:{primary:"ui-icon-minus"},label:"Remove",text:!1}),this.but_remove.click(this.remove.bind(this)),e.append(this.but_remove),this.content=jQuery("<div/>",{"class":this.class_+"-content"}),this.el.append(this.content),this.screen=new Sao.Screen(c.relation,{mode:["tree"],view_ids:(c.view_ids||"").split(","),views_preload:c.views||{},row_activate:this.activate.bind(this)}),this.prm=this.screen.switch_view("tree").done(function(){this.content.append(this.screen.screen_container.el)}.bind(this))},_get_color_el:function(){return this.screen.current_view&&"tree"==this.screen.current_view.view_type&&this.screen.current_view.el?this.screen.current_view.el:Sao.View.Form.Many2Many._super._get_color_el.call(this)},set_readonly:function(a){this._readonly=a,this._set_button_sensitive()},_set_button_sensitive:function(){var a=!1;this.record()&&this.field(),this.entry.prop("disabled",this._readonly),this.but_add.prop("disabled",this._readonly||a),this.but_remove.prop("disabled",this._readonly)},display:function(a,b){Sao.View.Form.Many2Many._super.display.call(this,a,b),this.prm.done(function(){if(a){if(void 0===b)return this.screen.new_group(),this.screen.set_current_record(null),this.screen.parent=!0,this.screen.display(),void 0;var c=a.field_get_client(this.field_name);c!=this.screen.group&&this.screen.set_group(c),this.screen.display()}}.bind(this))},activate:function(){this.edit()},add:function(){var a,b=this.field().get_domain(this.record()),c=this.field().get_context(this.record()),d=this.entry.val();a=d?[["rec_name","ilike","%"+d+"%"]].concat(b):b;var e=function(a){if(!jQuery.isEmptyObject(a)){var b,c,d=[];for(b=0,c=a.length;c>b;b++)d.push(a[b][0]);this.screen.group.load(d,!0),this.screen.display()}this.entry.val("")}.bind(this),f=new Sao.Model(this.attributes.relation),g=f.execute("search",[a,0,Sao.config.limit,null],c);g.done(function(a){if(1!=a.length){new Sao.Window.Search(this.attributes.relation,e,{sel_multi:!0,ids:a,context:c,domain:b,view_ids:(this.attributes.view_ids||"").split(","),views_preload:this.attributes.views||{},new_:this.attributes.create})}else e([[a[0],null]])}.bind(this))},remove:function(){this.screen.remove(!1,!0,!1)},key_press:function(a){var b=!0,c=[Sao.common.TAB_KEYCODE];this.wid_completion||c.push(Sao.common.RETURN_KEYCODE),a.which==Sao.common.F3_KEYCODE?(this.add(),a.preventDefault()):~c.indexOf(a.which)&&b&&this.entry.val()&&this.add()},edit:function(){if(this.screen.current_record){var a=function(a){a?this.screen.current_record.save().done(function(){this.screen.display()}.bind(this)):this.screen.current_record.cancel()};new Sao.Window.Form(this.screen,a.bind(this))}}}),Sao.View.Form.Binary=Sao.class_(Sao.View.Form.Widget,{class_:"form-binary",blob_url:"",init:function(a,b,c){Sao.View.Form.Binary._super.init.call(this,a,b,c),this.filename=c.filename||null,this.el=jQuery("<div/>",{"class":this.class_});var d=jQuery("<div/>");this.el.append(d),this.filename&&c.filename_visible&&(this.text=jQuery("<input/>",{type:"input"}),this.text.change(this.focus_out.bind(this)),this.text.on("keyup",this.key_press.bind(this)),d.append(this.text)),this.size=jQuery("<input/>",{type:"input"}),d.append(this.size),this.but_new=jQuery("<button/>").button({icons:{primary:"ui-icon-document"},text:!1}),this.but_new.click(this.new_.bind(this)),this.el.prepend(this.but_new),this.filename&&(this.but_open=jQuery("<a/>").button({icons:{primary:"ui-icon-folder-open"},text:!1}),this.but_open.click(this.open.bind(this)),this.el.prepend(this.but_open)),this.but_save_as=jQuery("<button/>").button({icons:{primary:"ui-icon-disk"},text:!1}),this.but_save_as.click(this.save_as.bind(this)),this.el.prepend(this.but_save_as),this.but_remove=jQuery("<button/>").button({icons:{primary:"ui-icon-trash"},text:!1}),this.but_remove.click(this.remove.bind(this)),this.el.prepend(this.but_remove)},filename_field:function(){var a=this.record();return a?a.model.fields[this.filename]:void 0},display:function(a,b){if(Sao.View.Form.Binary._super.display.call(this,a,b),!b)return this.size.val(""),this.filename&&this.but_open.button("disable"),this.text&&this.text.val(""),this.but_save_as.button("disable"),void 0;var c,d=b.get_size(a);c=d?"enable":"disable",this.filename&&(this.text&&this.text.val(this.filename_field().get(a)||""),this.but_open.button(c)),this.size.val(Sao.common.humanize(d)),this.but_save_as.button(c)},save_as:function(){var a=this.field(),b=this.record();a.get_data(b).done(function(a){var b=new Blob([a[0].binary],{type:"application/octet-binary"}),c=window.URL.createObjectURL(b);this.blob_url&&window.URL.revokeObjectURL(this.blob_url),this.blob_url=c,window.open(c)}.bind(this))},open:function(a){this.save_as(a)},new_:function(){var a=this.record(),b=jQuery("<div/>",{"class":"file-dialog"}),c=jQuery("<input/>",{type:"file"});b.append(c);var d=function(){var d=new FileReader;d.onload=function(){var b=new Uint8Array(d.result);this.field().set_client(a,b)}.bind(this),d.onloadend=function(){b.dialog("close")};var e=c[0].files[0];d.readAsArrayBuffer(e),this.filename&&this.filename_field().set_client(a,e.name)};b.dialog({modal:!0,title:"Select a file",buttons:{Cancel:function(){$(this).dialog("close")},OK:d.bind(this)}}),b.dialog("open")},remove:function(){this.field().set_client(this.record(),null)},key_press:function(a){var b=!0;a.which==Sao.common.F3_KEYCODE&&b?(this.new_(),a.preventDefault()):a.which==Sao.common.F2_KEYCODE&&(this.open(),a.preventDefault())},set_value:function(a){this.text&&this.filename_field().set_client(a,this.text.val()||"")},_get_color_el:function(){return this.text?this.text:this.size},set_readonly:function(a){a?(this.but_new.hide(),this.but_remove.hide()):(this.but_new.show(),this.but_remove.show())}})}(),function(){"use strict";Sao.Action={report_blob_url:void 0},Sao.Action.exec_action=function(a,b,c){void 0===c&&(c={}),b=void 0===b?{}:jQuery.extend({},b);var d={};switch(a.type){case"ir.action.act_window":d.view_ids=!1,d.view_mode=null,jQuery.isEmptyObject(a.views)?jQuery.isEmptyObject(a.view_id)||(d.view_ids=[a.view_id[0]]):(d.view_ids=[],d.view_mode=[],a.views.forEach(function(a){d.view_ids.push(a[0]),d.view_mode.push(a[1])})),void 0===a.pyson_domain&&(a.pyson_domain="[]");var e={active_model:b.res_model,active_id:b.id||!1,active_ids:b.ids},f=Sao.Session.current_session;e=jQuery.extend(e,f.context);var g=jQuery.extend({},e);g._user=f.user_id,d.context=new Sao.PYSON.Decoder(g).decode(a.pyson_context||"{}"),e=jQuery.extend(e,d.context),e=jQuery.extend(e,c);var h=jQuery.extend({},e);h.context=e,h._user=f.user_id,d.domain=new Sao.PYSON.Decoder(h).decode(a.pyson_domain);var i=jQuery.extend({},e);i.context=e,i._user=f.user_id,d.search_value=new Sao.PYSON.Decoder(i).decode(a.pyson_search_value||"[]");var j=jQuery.extend({},e);j.context=e,j._user=f.user_id;var k=new Sao.PYSON.Decoder(j);return d.tab_domain=[],a.domains.forEach(function(a){d.tab_domain.push([a[0],k.decode(a[1])])}),d.name=!1,a.window_name&&(d.name=a.name),d.model=a.res_model||b.res_model,d.res_id=a.res_id||b.res_id,d.limit=a.limit,d.auto_refresh=a.auto_refresh,d.icon=a["icon.rec_name"]||"",Sao.Tab.create(d),void 0;case"ir.action.wizard":return d.action=a.wiz_name,d.data=b,d.name=a.name,d.context=c,d.window=a.window,Sao.Wizard.create(d),void 0;case"ir.action.report":return d.name=a.report_name,d.data=b,d.direct_print=a.direct_print,d.email_print=a.email_print,d.email=a.email,d.context=c,Sao.Action.exec_report(d),void 0;case"ir.action.url":return window.open(a.url,"_blank"),void 0}},Sao.Action.exec_keyword=function(a,b,c,d,e){void 0===d&&(d=!0),void 0===e&&(e=!1);var f=b.id,g={method:"model.ir.action.keyword.get_keyword",params:[a,[b.model,f],{}]},h=Sao.rpc(g,Sao.Session.current_session),i=function(a){var f={};for(var g in a){var h=a[g];f[h.name.replace(/_/g,"")]=h}var i=Sao.common.selection("Select your action",f,e);return i.then(function(a){Sao.Action.exec_action(a,b,c)},function(){jQuery.isEmptyObject(f)&&d&&alert("No action defined!")})};return h.pipe(i)},Sao.Action.exec_report=function(a){a.context||(a.context={}),a.email||(a.email={});var b=jQuery.extend({},a.data),c=jQuery.extend({},Sao.Session.current_session.context);jQuery.extend(c,a.context),c.direct_print=a.direct_print,c.email_print=a.email_print,c.email=a.email;var d=Sao.rpc({method:"report."+a.name+".execute",params:[b.ids||[],b,c]},Sao.Session.current_session);d.done(function(a){var b=a[0],c=a[1],d=(a[2],a[3],new Blob([c],{type:Sao.common.guess_mimetype(b)})),e=window.URL.createObjectURL(d);Sao.Action.report_blob_url&&window.URL.revokeObjectURL(Sao.Action.report_blob_url),Sao.Action.report_blob_url=e,window.open(e)})},Sao.Action.execute=function(a,b,c,d){c?Sao.rpc({method:"model."+c+".search_read",params:[[["action","=",a]],0,1,null,null,d]},Sao.Session.current_session).done(function(a){Sao.Action.exec_action(a[0],b)}):Sao.rpc({method:"model.ir.action.read",params:[[a],["type"],d]},Sao.Session.current_session).done(function(c){Sao.Action.execute(a,b,c[0].type,d)})},Sao.Action.evaluate=function(a,b){switch(a=jQuery.extend({},a),b){case"print":case"action":break;case"relate":break;default:throw new Error("Action type "+b+" is not supported")}return a}}(),function(){"use strict";Sao.common={},Sao.common.BACKSPACE_KEYCODE=8,Sao.common.TAB_KEYCODE=9,Sao.common.RETURN_KEYCODE=13,Sao.common.DELETE_KEYCODE=46,Sao.common.F2_KEYCODE=113,Sao.common.F3_KEYCODE=114,Sao.common.SELECTION_NONE=1,Sao.common.SELECTION_SINGLE=2,Sao.common.SELECTION_MULTIPLE=3,Sao.common.compare=function(a,b){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]instanceof Array&&b[c]instanceof Array){if(!Sao.common.compare(a[c],b[c]))return!1}else if(a[c]!=b[c])return!1;return!0},Sao.common.contains=function(a,b){for(var c=0;c<a.length;c++)if(Sao.common.compare(a[c],b))return!0;return!1},Sao.common.intersect=function(a,b){for(var c=0,d=0,e=[];c<a.length&&d<b.length;)a[c]<b[d]?c++:a[c]>b[d]?d++:(e.push(a[c]),c++,d++);return e},Sao.common.selection=function(a,b,c){void 0===c&&(c=!1);var d=jQuery.Deferred();if(1==Object.keys(b).length&&!c){var e=Object.keys(b)[0];return d.resolve(b[e]),d}return d.fail()},Sao.common.date_format=function(){if(Sao.Session.current_session){var a=Sao.Session.current_session.context;if(a.locale&&a.locale.date)return a.locale.date.replace("%d","dd").replace("%j","oo").replace("%a","D").replace("%A","DD").replace("%m","mm").replace("%b","M").replace("%B","MM").replace("%y","y").replace("%Y","yy")}return jQuery.datepicker.W3C},Sao.common.format_time=function(a,b){var c=Sao.common.pad;return a.replace("%H",c(b.getHours(),2)).replace("%M",c(b.getMinutes(),2)).replace("%S",c(b.getSeconds(),2))},Sao.common.parse_time=function(a,b){if(jQuery.isEmptyObject(b))return null;var c=function(c){var d=a.indexOf(c);if(~d){var e=parseInt(b.slice(d,d+c.length),10);if(!isNaN(e))return e}return 0};return new Sao.Time(c("%H"),c("%M"),c("%S"))},Sao.common.format_datetime=function(a,b,c){return jQuery.datepicker.formatDate(a,c)+" "+Sao.common.format_time(b,c)},Sao.common.parse_datetime=function(a,b,c){var d=Sao.DateTime(jQuery.datepicker.parseDate(a,c)),e=c.replace(jQuery.datepicker.formatDate(a,d),"").trim(),f=Sao.common.parse_time(b,e);return d.setHours(f.getHours()),d.setMinutes(f.getMinutes()),d.setSeconds(f.getSeconds()),d},Sao.common.pad=function(a,b){for(var c=""+a;c.length<b;)c="0"+c;return c},Sao.common.text_to_float_time=function(a){return a},Sao.common.ModelAccess=Sao.class_(Object,{init:function(){this.batchnum=100,this._access={}},load_models:function(a){var b=jQuery.Deferred();return a||(this._access={}),Sao.rpc({method:"model.ir.model.list_models",params:[{}]},Sao.Session.current_session).then(function(a){for(var c=[],d=function(a){this._access=jQuery.extend(this._access,a)},e=0;e<a.length;e+=this.batchnum){var f=a.slice(e,e+this.batchnum);c.push(Sao.rpc({method:"model.ir.model.access.get_access",params:[f,{}]},Sao.Session.current_session).then(d.bind(this)))}jQuery.when.apply(jQuery,c).then(b.resolve,b.reject)}.bind(this)),b},get:function(a){return this._access[a]}}),Sao.common.MODELACCESS=new Sao.common.ModelAccess,Sao.common.humanize=function(a){for(var b=["bytes","KB","MB","GB","TB","PB"],c=0,d=b.length;d>c;c++){if(1e3>a)return a.toPrecision(4)+" "+b[c];a/=1e3}},Sao.common.EvalEnvironment=function(a,b){void 0===b&&(b="eval");var c;if("eval"==b)c=a.get_eval();else{c={};for(var d in a.model.fields){var e=a.model.fields[d];c[d]=e.get_on_change_value(a)}}return c.id=a.id,a.group.parent&&Object.defineProperty(c,"_parent_"+a.group.parent_name,{enumerable:!0,get:function(){return Sao.common.EvalEnvironment(a.group.parent,b)}}),c.get=function(a,b){return this.hasOwnProperty(a)?this[a]:b},c},Sao.common.selection_mixin={},Sao.common.selection_mixin.init=function(){this.selection=null,this.inactive_selection=[],this._last_domain=null,this._values2selection={},this._domain_cache={}},Sao.common.selection_mixin.init_selection=function(a,b){a||(a=[],(this.attributes.selection_change_with||[]).forEach(function(b){a.push([b,null])}),a.sort());var c=this.attributes.selection||[],d=function(a){a=jQuery.extend([],a),(void 0===this.attributes.sort||this.attributes.sort)&&a.sort(function(a,b){return a[1].localeCompare(b[1])}),this.selection=jQuery.extend([],a),b&&b(this.selection)};if(c instanceof Array||a in this._values2selection)a in this._values2selection&&(c=this._values2selection.selection),d.call(this,c);else{var e;if(a){var f={};a.forEach(function(a){f[a[0]]=a[1]}),e=this.model.execute(c,[f])}else e=this.model.execute(c,[]);e.pipe(d.bind(this))}this.inactive_selection=[]},Sao.common.selection_mixin.update_selection=function(a,b,c){if(!b)return c&&c(this.selection),void 0;if("relation"in this.attributes){var d=b.get_domain(a),e=JSON.stringify(d);if(e in this._domain_cache&&(this.selection=this._domain_cache[e],this._last_domain=d),null!==this._last_domain&&Sao.common.compare(d,this._last_domain))return c&&c(this.selection),void 0;var f=Sao.rpc({method:"model."+this.attributes.relation+".search_read",params:[d,0,null,null,["rec_name"],{}]},a.model.session);f.done(function(a){var b=[];a.forEach(function(a){b.push([a.id,a.rec_name])}),b.push([null,""]),this._last_domain=d,this._domain_cache[e]=b,this.selection=jQuery.extend([],b),c&&c(this.selection)}.bind(this)),f.fail(function(){this._last_domain=null,this.selection=[],c&&c(this.selection)}.bind(this))}else{var g=this.attributes.selection_change_with||[],h=[],i=a._get_on_change_args(g);for(var j in i)h.push([j,i[j]]);h.sort(),Sao.common.selection_mixin.init_selection.call(this,h,c)}},Sao.common.selection_mixin.get_inactive_selection=function(a){if(!this.attributes.relation)return jQuery.when([]);for(var b=0,c=this.inactive_selection.length;c>b;b++)if(a==this.inactive_selection[b][0])return jQuery.when(this.inactive_selection[b]);
var d=Sao.rpc({method:"model."+this.attributes.relation+".read",params:[[a],["rec_name"],{}]},Sao.Session.current_session);return d.then(function(a){return this.inactive_selection.push([a[0].id,a[0].rec_name]),[a[0].id,a[0].rec_name]}.bind(this))},Sao.common.Button=Sao.class_(Object,{init:function(a){this.attributes=a,this.el=jQuery("<button/>").button({text:!0,label:a.string||"",icons:{primary:"ui-icon-custom",secondary:null}}),this.set_icon(a.icon)},set_icon:function(a){if(a){var b=Sao.common.ICONFACTORY.register_icon(a);b.done(function(a){this.el.children(".ui-button-icon-primary").css("background-image",'url("'+a+'")')}.bind(this))}},set_state:function(a){var b;if(b=a?a.expr_eval(this.attributes.states||{}):{},b.invisible?this.el.hide():this.el.show(),this.el.prop("disabled",b.readonly),this.set_icon(b.icon||this.attributes.icon),a)for(var c=a.group.parent;c;){if(c.has_changed()){this.el.prop("disabled",!1);break}c=c.group.parent}}}),Sao.common.udlex=Sao.class_(Object,{init:function(a){var b=Sao.class_(Object,{init:function(a){this.stream=a.split(""),this.i=0},read:function(a){if(void 0===a&&(a=1),this.i>=this.stream.length)return null;var b=this.stream.slice(this.i,this.i+a).join();return this.i+=a,b}});this.instream=new b(a),this.eof=null,this.commenters="",this.nowordchars=[":",">","<","=","!",'"',";","(",")"],this.whitespace=" 	\r\n",this.whitespace_split=!1,this.quotes='"',this.escape="\\",this.escapedquotes='"',this.state=" ",this.pushback=[],this.token=""},get_token:function(){if(this.pushback.length>0)return this.pushback.shift();var a=this.read_token();return a},read_token:function(){for(var a=!1,b=" ";;){var c=this.instream.read(1);if(null===this.state){this.token="";break}if(" "==this.state){if(!c){this.state=null;break}if(this.whitespace.contains(c)){if(this.token||a)break;continue}if(this.commenters.contains(c));else if(this.escape.contains(c))b="a",this.state=c;else if(~this.nowordchars.indexOf(c))if(this.quotes.contains(c))this.state=c;else{if(!this.whitespace_split){if(this.token=c,this.token||a)break;continue}this.token=c,this.state="a"}else this.token=c,this.state="a"}else if(this.quotes.contains(this.state)){if(a=!0,!c)throw"no closing quotation";c==this.state?this.state="a":this.escape.contains(c)&&this.escapedquotes.contains(this.state)?(b=this.state,this.state=c):this.token=this.token+c}else if(this.escape.contains(this.state)){if(!c)throw"no escaped character";this.quotes.contains(b)&&c!=this.state&&c!=b&&(this.token=this.token+this.state),this.token=this.token+c,this.state=b}else if("a"==this.state){if(!c){this.state=null;break}if(this.whitespace.contains(c)){if(this.state=" ",this.token||a)break;continue}if(this.commenters.contains(c));else if(this.quotes.contains(c))this.state=c;else if(this.escape.contains(c))b="a",this.state=c;else{if(~this.nowordchars.indexOf(c)&&!this.quotes.contains(c)&&!this.whitespace_split){if(this.pushback.unshift(c),this.state=" ",this.token)break;continue}this.token=this.token+c}}}var d=this.token;return this.token="",a||""!==d||(d=null),d},next:function(){var a=this.get_token();return a==this.eof?null:a}}),Sao.common.DomainParser=Sao.class_(Object,{OPERATORS:["!=","<=",">=","=","!","<",">"],init:function(a){this.fields={},this.strings={};for(var b in a){var c=a[b];(c.searchable||void 0===c.searchable)&&(this.fields[b]=c,this.strings[c.string.toLowerCase()]=c)}},parse:function(a){try{for(var b=new Sao.common.udlex(a),c=[];;){var d=b.next();if(null===d)break;c.push(d)}return c=this.group_operator(c),c=this.parenthesize(c),c=this.group(c),c=this.operatorize(c,"or"),c=this.operatorize(c,"and"),c=this.parse_clause(c),this.simplify(c)}catch(e){if("no closing quotation"==e)return this.parse(a+'"');throw e}},string:function(a){var b=function(a){if(jQuery.isEmptyObject(a))return"";var b;if("string"==typeof a[0]&&(a[0]in this.fields||"rec_name"==a[0])){var c=a[0],d=a[1],e=a[2];if(!(c in this.fields))return b=e.replace("%%","__"),b.startsWith("%")&&b.endsWith("%")&&(e=e.slice(1,-1)),this.quote(e);var f=this.fields[c];d.contains("ilike")&&(b=e.replace("%%","__"),b.startsWith("%")&&b.endsWith("%")?e=e.slice(1,-1):b.contains("%")||(d="ilike"==d?"=":"!",e=e.replace("%%","%")));var g=this.default_operator(f);(g==d.trim()||d.contains(g)&&d.contains("not"))&&(d=d.replace(g,"").replace("not","!").trim()),d.endsWith("in")&&(d="not in"==d?"!":"");var h=this.format_value(f,e);return~this.OPERATORS.indexOf(d)&&~["char","text","sha","selection"].indexOf(f.type)&&""===e&&(h='""'),this.quote(f.string)+": "+d+h}return"("+this.string(a)+")"};if(b=b.bind(this),jQuery.isEmptyObject(a))return"";var c=" ";return("AND"==a[0]||"OR"==a[0])&&("OR"==a[0]&&(c=" or "),a=a.slice(1)),a.map(b).join(c)},group_operator:function(a){var b=a[0],c=[];return a.slice(1).forEach(function(a){"="==a&&b&&~this.OPERATORS.indexOf(b+a)?(c.push(b+a),b=null):(null!==b&&c.push(b),b=a)}.bind(this)),null!==b&&c.push(b),c},parenthesize:function(a){var b=[],c=b,d=[];return a.forEach(function(a){void 0!==c&&("("==a?(d.push(c),c=c[c.push([])-1]):")"==a?c=d.pop():c.push(a))}),b},group:function(a){var b=[],c=function(a){var b=[],d=function(a){b.push([a])},e=a.indexOf(":");if(!~e)return a.forEach(d),b;for(var f=function(a,c){return function(d){jQuery.isEmptyObject(a)?b.push(d):(jQuery.isEmptyObject(c)?b.push(a.concat(d)):(null!==d[0]&&c.push(d[0]),b.push(a.concat([c]))),a.splice(0,a.length))}},g=0;e>g;g++){var h=a.slice(g,e).join(" ");if(h.toLowerCase()in this.strings){jQuery.isEmptyObject(a.slice(0,g))?d(null):a.slice(0,g).forEach(d),h=[h],e+1<a.length&&~this.OPERATORS.indexOf(a[e+1])?(h=h.concat([a[e+1]]),e+=1):h=h.concat([null]);for(var i=[];e+2<a.length&&";"==a[e+2];)i.push(a[e+1]),e+=2;c(a.slice(e+1)).forEach(f(h,i)),jQuery.isEmptyObject(h)||(jQuery.isEmptyObject(i)?b.push(h.concat([null])):b.push(h.concat([i])));break}}return b};c=c.bind(this);var d=[];return a.forEach(function(a){a instanceof Array?(c(d).forEach(function(a){Sao.common.compare(a,[null])||b.push(a)}),d=[],b.push(this.group(a))):d.push(a)}.bind(this)),c(d).forEach(function(a){Sao.common.compare(a,[null])||b.push(a)}),b},operatorize:function(a,b){var c=[];b=b||"or",a=jQuery.extend([],a);for(var d=function(a){return a instanceof Array?Sao.common.compare(a,[b]):a==b},e=a.shift();d(e);)e=a.shift();if(void 0===e)return c;e instanceof Array&&(e=this.operatorize(e,b));for(var f=null;!jQuery.isEmptyObject(a);)if(f=a.shift(),f instanceof Array&&!d(f)&&(f=this.operatorize(f,b)),d(f)){for(f=a.shift();d(f);)f=a.shift();f instanceof Array&&(f=this.operatorize(f,b)),void 0!==f?e=[b.toUpperCase(),e,f]:d(e)||(c.push([b.toUpperCase(),e]),e=null),f=null}else d(e)||c.push(e),e=f;return jQuery.isEmptyObject(a)&&(null===f||d(f)?null===e||d(f)||c.push(e):c.push(f)),c},parse_clause:function(a){var b=[];return a.forEach(function(a){if("OR"==a||"AND"==a)b.push(a);else if(1!=a.length||a[0]instanceof Array)if(3==a.length&&a[0].toLowerCase()in this.strings){var c=(a[0],a[1]),d=a[2],e=this.strings[a[0].toLowerCase()];if(null===c&&(c=this.default_operator(e)),d instanceof Array&&(c="!"==c?"not in":"in"),"!"==c&&(c=this.negate_operator(this.default_operator(e))),c.contains("like")&&(d=this.likify(d)),~["integer","float","numeric","datetime","date","time"].indexOf(e.type)&&d&&d.contains("..")){var f=d.split("..",2),g=this.convert_value(e,f[0]),h=this.convert_value(e,f[1]);return b.push([[e.name,">=",g],[e.name,"<",h]]),void 0}d=d instanceof Array?d.map(function(a){return this.convert_value(e,a)}.bind(this)):this.convert_value(e,d),b.push([e.name,c,d])}else b.push(this.parse_clause(a));else b.push(["rec_name","ilike",this.likify(a[0])])}.bind(this)),b},likify:function(a){if(!a)return"%";var b=a.replace("%%","__");return b.contains("%")?a:"%"+a+"%"},quote:function(a){if("string"!=typeof a)return a;for(var b=[":"," ","(",")"].concat(this.OPERATORS),c=0;c<b.length;c++){var d=b[c];if(a.contains(d))return'"'+a+'"'}return a},default_operator:function(a){return~["char","text","many2one","many2many","one2many"].indexOf(a.type)?"ilike":"="},negate_operator:function(a){switch(a){case"ilike":return"not ilike";case"=":return"!=";case"in":return"not in"}},time_format:function(a){return new Sao.PYSON.Decoder({}).decode(a.format)},convert_value:function(a,b){var c=function(){if("string"==typeof b)for(var c=0;c<a.selection.length;c++){var d=a.selection[c],e=d[0],f=d[1];if(b.toLowerCase()==f.toLowerCase())return e}return b},d={"boolean":function(){return"string"==typeof b?["y","yes","true","t","1"].some(function(a){return a.toLowerCase().startsWith(b.toLowerCase())}):Boolean(b)},"float":function(){var a=Number(b);return isNaN(a)||""===b||null===b?null:a},integer:function(){var a=parseInt(b,10);return isNaN(a)?null:a},numeric:function(){var a=new Sao.Decimal(b);return isNaN(a.valueOf())||""===b||null===b?null:a},selection:c,reference:c,datetime:function(){try{return Sao.common.parse_datetime(Sao.common.date_format(),this.time_format(a),b)}catch(c){try{return Sao.DateTime(jQuery.datepicker.parseDate(Sao.common.date_format(),b))}catch(d){return null}}}.bind(this),date:function(){try{return Sao.Date(jQuery.datepicker.parseDate(Sao.common.date_format(),b))}catch(a){return null}},time:function(){try{return Sao.common.parse_time(this.time_format(a),b)}catch(c){return null}}.bind(this),many2one:function(){return""===b?null:b}},e=d[a.type];return e?e():b},format_value:function(a,b){var c=function(){if(!b&&0!==b&&b!==new Sao.Decimal(0))return"";var a=String(b).split(".")[1];return a=a?a.length:0,b.toFixed(a)},d=function(){for(var c=0;c<a.selection.length;c++)if(a.selection[c][0]==b)return a.selection[c][1];return b||""},e={"boolean":function(){return b?"True":"False"},integer:function(){return b||0===b?""+parseInt(b,10):""},"float":c,numeric:c,selection:d,reference:d,datetime:function(){return b?b.isDate||!(b.getHours()||b.getMinutes()||b.getSeconds())?jQuery.datepicker.formatDate(Sao.common.date_format(),b):Sao.common.format_datetime(Sao.common.date_format(),this.time_format(a),b):""}.bind(this),date:function(){return b?jQuery.datepicker.formatDate(Sao.common.date_format(),b):""},time:function(){return b?Sao.common.format_time(this.time_format(a),b):""}.bind(this),many2one:function(){return null===b?"":b}};if(b instanceof Array)return b.map(function(b){return this.format_value(a,b)}.bind(this)).join(";");var f=e[a.type];return f?this.quote(f(b)):null===b?"":this.quote(b)},simplify:function(a){return a instanceof Array?1==a.length&&a[0]instanceof Array&&("AND"==a[0][0]||"OR"==a[0][0]||a[0][0]instanceof Array)?this.simplify(a[0]):2==a.length&&("AND"==a[0]||"OR"==a[0])&&a[1]instanceof Array?this.simplify(a[1]):(3==a.length&&("AND"==a[0]||"OR"==a[0])&&a[1]instanceof Array&&a[0]==a[1][0]&&(a=this.simplify(a[1]).concat([a[2]])),a.map(this.simplify.bind(this))):a}}),Sao.common.DomainInversion=Sao.class_(Object,{and:function(a,b){return a&&b},or:function(a,b){return a||b},OPERATORS:{"=":function(a,b){return a instanceof Array&&b instanceof Array?Sao.common.compare(a,b):a===b},">":function(a,b){return a>b},"<":function(a,b){return b>a},"<=":function(a,b){return b>=a},">=":function(a,b){return a>=b},"!=":function(a,b){return a instanceof Array&&b instanceof Array?!Sao.common.compare(a,b):a!==b},"in":function(a,b){return Sao.common.DomainInversion.in_(a,b)},"not in":function(a,b){return!Sao.common.DomainInversion.in_(a,b)},like:function(){return!0},ilike:function(){return!0},"not like":function(){return!0},"not ilike":function(){return!0},child_of:function(){return!0},"not child_of":function(){return!0}},locale_part:function(a,b){return a===b?"id":a.contains(".")?a.split(".").slice(1).join("."):a},is_leaf:function(a){return a instanceof Array&&a.length>2&&a[1]in this.OPERATORS},eval_leaf:function(a,b,c){void 0===c&&(c=this.and);var d=a[0],e=a[1],f=a[2];if(d.contains("."))return Boolean(b[d.split(".")[0]]);if("="==e&&!b[d]&&c===this.and)return!0;var g=b[d];return"string"==typeof g&&f instanceof Array&&2==f.length?f=f.join(","):g instanceof Array&&"string"==typeof f&&2==g.length&&(g=g.join(",")),this.OPERATORS[e](g,f)},inverse_leaf:function(a){return~["AND","OR"].indexOf(a)?a:this.is_leaf(a)?a[1].contains("child_of")?3==a.length?a:[a[3]].concat(a.slice(1)):a:a.map(this.inverse_leaf.bind(this))},eval_domain:function(a,b,c){return void 0===c&&(c=this.and),this.is_leaf(a)?this.eval_leaf(a,b,c):jQuery.isEmptyObject(a)&&c==this.and?!0:jQuery.isEmptyObject(a)&&c==this.or?!1:"AND"==a[0]?this.eval_domain(a.slice(1),b):"OR"==a[0]?this.eval_domain(a.slice(1),b,this.or):c(this.eval_domain(a[0],b),this.eval_domain(a.slice(1),b,c))},localize_domain:function(a,b){return~["AND","OR",!0,!1].indexOf(a)?a:this.is_leaf(a)?a[1].contains("child_of")?3==a.length?a:[a[3]].concat(a.slice(1,-1)):[this.locale_part(a[0],b)].concat(a.slice(1)):a.map(function(a){return this.localize_domain(a,b)}.bind(this))},unlocalize_domain:function(a,b){return~["AND","OR",!0,!1].indexOf(a)?a:this.is_leaf(a)?[b+"."+a[0]].concat(a.slice(1)):a.map(function(a){return this.unlocalize_domain(a,b)}.bind(this))},simplify:function(a){return this.is_leaf(a)?a:~["OR","AND"].indexOf(a)?a:a instanceof Array&&1==a.length&&!this.is_leaf(a[0])?this.simplify(a[0]):a instanceof Array&&2==a.length&&~["AND","OR"].indexOf(a[0])?[this.simplify(a[1])]:a.map(this.simplify.bind(this))},merge:function(a,b){if(jQuery.isEmptyObject(a)||~["AND","OR"].indexOf(a))return[];var c="OR"==a[0]?"OR":"AND";return this.is_leaf(a)?[a]:void 0===b?[c].concat([].concat.apply([],a.map(function(a){return this.merge(a,c)}.bind(this)))):c==b?[].concat.apply([],a.map(function(a){return this.merge(a,c)}.bind(this))):[this.merge(a)]},parse:function(a){var b=Sao.common.DomainInversion.And,c=Sao.common.DomainInversion.Or;if(this.is_leaf(a))return a;if(jQuery.isEmptyObject(a))return new b([]);if("OR"===a[0])return new c(a.slice(1));var d=0;return"AND"===a[0]&&(d=1),new b(a.slice(d))},domain_inversion:function(a,b,c){void 0===c&&(c={});var d=this.parse(a);return~d.variables.indexOf(b)?d.inverse(b,c):!0}}),Sao.common.DomainInversion.in_=function(a,b){if(a instanceof Array){for(var c=0,d=a.length;d>c;c++)if(~b.indexOf(a[c]))return!0;return!1}return Boolean(~b.indexOf(a))},Sao.common.DomainInversion.And=Sao.class_(Object,{init:function(a){this.domain_inversion=new Sao.common.DomainInversion,this.branches=a.map(this.domain_inversion.parse.bind(this.domain_inversion)),this.variables=[];for(var b=0,c=this.branches.length;c>b;b++){var d=this.branches[b];this.domain_inversion.is_leaf(d)?this.variables.push(this.base(d[0])):d instanceof Sao.common.DomainInversion.And&&(this.variables=this.variables.concat(d.variables))}},base:function(a){return a.contains(".")?a.split(".")[0]:a},inverse:function(a,b){for(var c=Sao.common.DomainInversion,d=[],e=0,f=this.branches.length;f>e;e++){var g=this.branches[e];if(g instanceof c.And){var h=g.inverse(a,b),i="boolean"==typeof h;if(i){if(h)continue;return!1}d.push(h)}else if(this.domain_inversion.is_leaf(g)&&this.base(g[0])===a)d.push(g);else{var j=g[0];if(j in b&&!(j in b&&this.domain_inversion.eval_leaf(g,b,this.domain_inversion.and)))return!1;d.push(!0)}}return d=d.filter(function(a){return a!==!0}),jQuery.isEmptyObject(d)?!0:this.domain_inversion.simplify(d)}}),Sao.common.DomainInversion.Or=Sao.class_(Sao.common.DomainInversion.And,{inverse:function(a,b){var c=Sao.common.DomainInversion,d=[];if(!~this.variables.indexOf(a)&&!jQuery.isEmptyObject(this.variables.filter(function(a){return!(a in b)})))return!0;for(var e=0,f=this.branches.length;f>e;e++){var g=this.branches[e];if(g instanceof c.And){var h=g.inverse(a,b),i="boolean"==typeof h;if(!~this.variables.indexOf(a)){if(i&&h)return!0;continue}if(i){if(h)return!0;continue}d.push(h)}else if(this.domain_inversion.is_leaf(g)&&this.base(g[0])==a)d.push(g);else{var j=g[0];if(j=this.base(j),j in b&&this.domain_inversion.eval_leaf(g,b,this.domain_inversion.or))return!0;j in b&&!this.domain_inversion.eval_leaf(g,b,this.domain_inversion.or)&&d.push(!1)}}return d=d.filter(function(a){return a!==!1}),jQuery.isEmptyObject(d)?!1:this.domain_inversion.simplify(["OR"].concat(d))}}),Sao.common.guess_mimetype=function(a){return/.*odt$/.test(a)?"application/vnd.oasis.opendocument.text":/.*ods$/.test(a)?"application/vnd.oasis.opendocument.spreadsheet":/.*pdf$/.test(a)?"application/pdf":/.*docx$/.test(a)?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":/.*doc/.test(a)?"application/msword":/.*xlsx$/.test(a)?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":/.*xls/.test(a)?"application/vnd.ms-excel":"application/octet-binary"},Sao.common.LOCAL_ICONS=["tryton-attachment-hi","tryton-attachment","tryton-bookmark","tryton-clear","tryton-close","tryton-connect","tryton-copy","tryton-delete","tryton-dialog-error","tryton-dialog-information","tryton-dialog-warning","tryton-disconnect","tryton-executable","tryton-find-replace","tryton-find","tryton-folder-new","tryton-fullscreen","tryton-go-home","tryton-go-jump","tryton-go-next","tryton-go-previous","tryton-help","tryton-icon","tryton-list-add","tryton-list-remove","tryton-locale","tryton-lock","tryton-log-out","tryton-mail-message-new","tryton-mail-message","tryton-new","tryton-open","tryton-preferences-system-session","tryton-preferences-system","tryton-preferences","tryton-print-email","tryton-print-open","tryton-print","tryton-refresh","tryton-save-as","tryton-save","tryton-star","tryton-start-here","tryton-system-file-manager","tryton-system","tryton-text-background","tryton-text-foreground","tryton-text-markup","tryton-undo","tryton-unstar","tryton-web-browser"],Sao.common.IconFactory=Sao.class_(Object,{batchnum:10,name2id:{},loaded_icons:{},tryton_icons:[],load_icons:function(a){if(a=a||!1,!a){this.name2id={};for(var b in this.load_icons)this.load_icons.hasOwnProperty(b)&&window.URL.revokeObjectURL(this.load_icons[b]);this.loaded_icons={}}this.tryton_icons=[];var c=new Sao.Model("ir.ui.icon");return c.execute("list_icons",[]).then(function(b){for(var c,d,e=0,f=b.length;f>e;e++)c=b[e][0],d=b[e][1],a&&d in this.loaded_icons||(this.tryton_icons.push([c,d]),this.name2id[d]=c)}.bind(this))},register_icon:function(a){if(!a)return jQuery.when("");if(a in this.loaded_icons||~Sao.common.LOCAL_ICONS.indexOf(a))return jQuery.when(this.get_icon_url(a));var b;b=a in this.name2id?jQuery.when():this.load_icons(!0);var c=new Sao.Model("ir.ui.icon");return b.then(function(){var b=function(a){var b,c;for(b=0,c=this.tryton_icons.length;c>b;b++){var d=this.tryton_icons[b];if(Sao.common.compare(d,a))break}return b}.bind(this),d=b([this.name2id[a],a]),e=Math.round(d-this.batchnum/2);e=0>e?0:e;var f=Math.round(d+this.batchnum/2),g=[];this.tryton_icons.slice(e,f).forEach(function(a){g.push(a[0])});var h=c.execute("read",[g,["name","icon"]]);return h.then(function(c){return c.forEach(function(a){var c=new Blob([a.icon],{type:"image/svg+xml"}),d=window.URL.createObjectURL(c);this.loaded_icons[a.name]=d,delete this.name2id[a.name],this.tryton_icons.splice(b([a.id,a.name]),1)}.bind(this)),this.get_icon_url(a)}.bind(this))}.bind(this))},get_icon_url:function(a){return a in this.loaded_icons?this.loaded_icons[a]:"images/"+a+".svg"}}),Sao.common.ICONFACTORY=new Sao.common.IconFactory,Sao.common.UniqueDialog=Sao.class_(Object,{init:function(){this.running=!1},build_dialog:function(){},run:function(){if(!this.running){var a=Array.prototype.slice.call(arguments),b=jQuery.Deferred();a.push(b);var c=this.build_dialog.apply(this,a);return this.running=!0,c.dialog("open"),b}},close:function(a){a.dialog("close"),this.running=!1}}),Sao.common.MessageDialog=Sao.class_(Sao.common.UniqueDialog,{class_:"message-dialog",build_dialog:function(a,b,c){var d=jQuery("<div/>",{"class":this.class_});return d.append(jQuery("<p/>").text(a).prepend(jQuery("<span/>",{"class":"dialog-icon"}).append(jQuery("<span/>",{"class":"ui-icon "+b})))),d.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){this.close(d),c.resolve("ok")}.bind(this)}}),d},run:function(a,b){Sao.common.MessageDialog._super.run.call(this,a,b||"ui-icon-info")}}),Sao.common.message=new Sao.common.MessageDialog}(),function(){"use strict";Sao.Window={},Sao.Window.Form=Sao.class_(Object,{init:function(a,b,c){c=c||{},this.screen=a,this.screen.screen_container.alternate_view=!0;for(var d=c.view_type||"form",e=jQuery.when(),f=[],g=0,h=this.screen.views.length;h>g;g++)f.push(this.screen.views[g].view_type);~f.indexOf(d)||~this.screen.view_to_load.indexOf(d)||(e=this.screen.add_view_id(null,d));var i=e.then(function(){return this.screen.switch_view(d).done(function(){c.new_&&this.screen.new_()}.bind(this))}.bind(this));this.many=c.many||0,this.domain=c.domain||null,this.context=c.context||null,this.save_current=c.save_current,this.prev_view=a.current_view,this.callback=b,this.el=jQuery("<div/>");var j=[];j.push({text:!c.new_&&this.screen.current_view&&this.screen.current_record.id<0?"Delete":"Cancel",click:function(){this.response("RESPONSE_CANCEL")}.bind(this)}),c.new_&&this.many&&j.push({text:"New",click:function(){this.response("RESPONSE_ACCEPT")}.bind(this)}),this.save_current?j.push({text:"Save",click:function(){this.response("RESPONSE_OK")}.bind(this)}):j.push({text:"OK",click:function(){this.response("RESPONSE_OK")}.bind(this)});var k;if("tree"==d){k=jQuery("<div/>");var l=Sao.common.MODELACCESS.get(this.screen.model_name);this.domain&&(this.wid_text=jQuery("<input/>",{type:"input"}),k.append(this.wid_text),this.but_add=jQuery("<button/>").button({icons:{primary:"ui-icon-plus"},label:"Add"}),this.but_add.click(this.add.bind(this)),k.append(this.but_add),this.but_add.prop("disabled",!l.read),this.but_remove=jQuery("<button/>").button({icons:{primary:"ui-icon-minus"},label:"Remove"}),this.but_remove.click(this.remove.bind(this)),k.append(this.but_remove),this.but_remove.prop("disabled",!l.read)),this.but_new=jQuery("<button/>").button({icons:{primary:"ui-icon-document"},label:"New"}),this.but_new.click(this.new_.bind(this)),k.append(this.but_new),this.but_new.prop("disabled",!l.create),this.but_del=jQuery("<button/>").button({icons:{primary:"ui-icon-trash"},label:"Delete"}),this.but_del.click(this.delete_.bind(this)),k.append(this.but_del),this.but_del.prop("disabled",!l["delete"]),this.but_undel=jQuery("<button/>").button({icons:{primary:"ui-icon-arrowreturn-1-s"},label:"Undelete"}),this.but_undel.click(this.undelete.bind(this)),k.append(this.but_undel),this.but_previous=jQuery("<button/>").button({icons:{primary:"ui-icon-arrowthick-1-w"},label:"Previous"}),this.but_previous.click(this.previous.bind(this)),k.append(this.but_previous),this.label=jQuery("<span/>"),this.label.text("(0, 0)"),k.append(this.label),this.but_next=jQuery("<button/>").button({icons:{primary:"ui-icon-arrowthick-1-e"},label:"Next"}),this.but_next.click(this.next.bind(this)),k.append(this.but_next),this.but_switch=jQuery("<button/>").button({icons:{primary:"ui-icon-newwin"},label:"Switch"}),this.but_switch.click(this.switch_.bind(this)),k.append(this.but_switch)}i.done(function(){this.el.dialog({modal:!0,autoOpen:!1,buttons:j,title:""}),k&&this.el.append(k),this.el.append(this.screen.screen_container.alternate_viewport),this.el.dialog("open"),this.screen.display()}.bind(this))},add:function(){},remove:function(){this.screen.remove(!1,!0,!1)},new_:function(){this.screen.new_()},delete_:function(){this.screen.remove(!1,!1,!1)},undelete:function(){this.screen.unremove()},previous:function(){this.screen.display_previous()},next:function(){this.screen.display_next()},switch_:function(){this.screen.switch_view()},response:function(a){var b;if(this.screen.current_view.set_value(),~["RESPONSE_OK","RESPONSE_ACCEPT"].indexOf(a)&&this.screen.current_record)return this.screen.current_record.validate().then(function(c){var d=jQuery.Deferred();if(c&&this.save_current)this.screen.save_current().then(d.resolve,d.reject);else if(c&&"form"==this.screen.current_view.view_type){var e=(this.screen.current_view,[]);for(var f in this.widgets){var g=this.widgets[f];if(g.screen&&g.screen.pre_validate){var h=g.screen.current_record;h&&e.push(h.pre_validate())}}jQuery.when.apply(jQuery,e).then(d.resolve,d.reject)}else c?d.resolve():d.reject();d.fail(function(){this.screen.display()}.bind(this)),d.done(function(){"RESPONSE_ACCEPT"==a?(this.screen.new_(),this.screen.current_view.display(),this.many-=1,0===this.many&&this.but_new.prop("disabled",!0)):(this.callback(b),this.destroy())}.bind(this))}.bind(this)),void 0;if("RESPONSE_CANCEL"==a&&this.screen.current_record){if(b=!1,this.screen.current_record.id<0||this.save_current)this.screen.group.remove(this.screen.current_record,!0);else if(this.screen.current_record.has_changed())return this.screen.current_record.cancel(),this.screen.current_record.reload().always(function(){this.callback(b),this.destroy()}.bind(this)),void 0}else b="RESPONSE_CANCEL"!=a;this.callback(b),this.destroy()},destroy:function(){this.screen.screen_container.alternate_view=!1,this.screen.screen_container.alternate_viewport.children().detach(),this.el.dialog("destroy")}}),Sao.Window.Attachment=Sao.class_(Sao.Window.Form,{init:function(a,b){this.resource=a.model.name+","+a.id,this.attachment_callback=b;var c=new Sao.Screen("ir.attachment",{domain:[["resource","=",this.resource]],mode:["tree","form"],context:{resource:this.resource},exclude_field:"resource"});c.switch_view().done(function(){c.search_filter(),c.parent=a}),Sao.Window.Attachment._super.init.call(this,c,this.callback,{view_type:"tree"})},callback:function(a){a&&this.screen.group.save(),this.attachment_callback&&this.attachment_callback()}}),Sao.Window.Search=Sao.class_(Object,{init:function(a,b,c){c=c||{};var d=c.views_preload||{};this.model_name=a,this.domain=c.domain||[],this.context=c.context||{},this.sel_multi=c.sel_multi,this.callback=b,this.el=jQuery("<div/>");var e=[];e.push({text:"Cancel",click:function(){this.response("RESPONSE_CANCEL")}.bind(this)}),e.push({text:"Find",click:function(){this.response("RESPONSE_APPLY")}.bind(this)}),c.new_&&Sao.common.MODELACCESS.get(a).create&&e.push({text:"New",click:function(){this.response("RESPONSE_ACCEPT")}.bind(this)}),e.push({text:"OK",click:function(){this.response("RESPONSE_OK")}.bind(this)}),this.el.dialog({modal:!0,title:"Search",autoOpen:!1,buttons:e}),this.screen=new Sao.Screen(a,{mode:["tree"],context:this.context,view_ids:c.view_ids,views_preload:d}),jQuery.isEmptyObject(c.ids)||this.screen.new_group(c.ids),this.screen.load_next_view().done(function(){this.screen.switch_view().done(function(){this.el.append(this.screen.screen_container.el),this.el.dialog("open"),this.screen.display()}.bind(this))}.bind(this))},response:function(a){var b,c=[];if("RESPONSE_OK"==a)b=this.screen.current_view.selected_records();else{if("RESPONSE_APPLY"==a)return this.screen.search_filter(),void 0;if("RESPONSE_ACCEPT"==a){var d=new Sao.Screen(this.model_name,{domain:this.domain,context:this.context,mode:["form"]}),e=function(a){a?d.save_current().then(function(){var a=d.current_record;this.callback([[a.id,a._values.rec_name||""]])}.bind(this),function(){this.callback(null)}.bind(this)):this.callback(null)};return this.el.dialog("destroy"),new Sao.Window.Form(d,e.bind(this),{new_:!0}),void 0}}if(b){var f,g;for(f in b)g=b[f],c.push([g.id,g._values.rec_name||""])}this.callback(c),this.el.dialog("destroy")}}),Sao.Window.Preferences=Sao.class_(Object,{init:function(a){this.callback=a,this.el=jQuery("<div/>");var b=[];b.push({text:"Cancel",click:function(){this.response("RESPONSE_CANCEL")}.bind(this)}),b.push({text:"Ok",click:function(){this.response("RESPONSE_OK")}.bind(this)}),this.el.dialog({modal:!0,title:"Preferences",autoOpen:!1,buttons:b}),this.screen=new Sao.Screen("res.user",{mode:[]});var c=function(a){this.screen.add_view(a),this.screen.switch_view().done(function(){this.screen.new_(!1),this.screen.model.execute("get_preferences",[!1],{}).then(d.bind(this),this.destroy)}.bind(this))},d=function(a){this.screen.current_record.set(a),this.screen.current_record.id=this.screen.model.session.user_id,this.screen.current_record.validate(null,!0).then(function(){this.screen.display()}.bind(this)),this.el.append(this.screen.screen_container.el),this.el.dialog("open")};this.screen.model.execute("get_preferences_fields_view",[],{}).then(c.bind(this),this.destroy)},response:function(a){"RESPONSE_OK"==a&&this.screen.current_record.validate().then(function(a){if(a){var b=jQuery.extend({},this.screen.get()),c=!1;if("password"in b&&(c=window.prompt("Current Password:"),!c))return;this.screen.model.execute("set_preferences",[b,c],{}).done(function(){this.destroy(),this.callback()}.bind(this))}else this.destroy(),this.callback()}.bind(this)),this.destroy(),this.callback()},destroy:function(){this.el.dialog("destroy")}})}(),function(){"use strict";Sao.Wizard=Sao.class_(Object,{init:function(a){this.widget=jQuery("<div/>",{"class":"wizard"}),this.name=a,this.id=null,this.ids=null,this.action=null,this.context=null,this.states={},this.session_id=null,this.start_state=null,this.end_state=null,this.screen=null,this.screen_state=null,this.state=null,this.session=Sao.Session.current_session,this.__processing=!1,this.__waiting_response=!1},run:function(a){this.action=a.action,this.id=a.data.id,this.ids=a.data.ids,this.model=a.data.model,this.context=a.context,Sao.rpc({method:"wizard."+this.action+".create",params:[this.session.context]},this.session).then(function(a){this.session_id=a[0],this.start_state=this.state=a[1],this.end_state=a[2],this.process()}.bind(this))},process:function(){if(!this.__processing&&!this.__waiting_response){var a=function(){if(this.state==this.end_state)return this.end(),void 0;var b=jQuery.extend({},this.context);b.active_id=this.id,b.active_ids=this.ids,b.active_model=this.model;var c={};this.screen&&(c[this.screen_state]=this.screen.get_on_change_value()),Sao.rpc({method:"wizard."+this.action+".execute",params:[this.session_id,c,this.state,b]},this.session).then(function(c){if(c.view){this.clean();var d=c.view;this.update(d.fields_view,d.defaults,d.buttons),this.screen_state=d.state,this.__waiting_response=!0}else this.state=this.end_state;(!c.actions||(c.view||this.end(),c.actions.forEach(function(a){Sao.Action.exec_action(a[0],a[1],b)}),c.view&&"ir.action.wizard"!=c.actions[c.actions.length-1].type))&&(this.__waiting_response?this.state==this.end_state&&this.end():a(),this.__processing=!1)}.bind(this),function(){this.__processing=!1}.bind(this))};a.call(this)}},destroy:function(){},end:function(){Sao.rpc({method:"wizard."+this.action+".delete",params:[this.session_id,this.session.context]},this.session)},clean:function(){this.widget.children().remove(),this.states={}},response:function(a){this.__waiting_response=!1,this.screen.current_view.set_value(),this.screen.current_record.validate().then(function(b){return b||a==this.end_state?(this.state=a,this.process(),void 0):(this.screen.display(),void 0)}.bind(this))},_get_button:function(a){var b=new Sao.common.Button(a);return this.states[a.state]=b,b},update:function(a,b,c){c.forEach(function(a){this._get_button(a)}.bind(this)),this.screen=new Sao.Screen(a.model,{mode:[],context:this.context}),this.screen.add_view(a),this.screen.switch_view(),this.widget.append(this.screen.screen_container.el),this.screen.new_(!1),this.screen.current_record.set_default(b)}}),Sao.Wizard.create=function(a){var b;b=a.window?new Sao.Wizard.Form(a.name):new Sao.Wizard.Dialog(a.name),b.run(a)},Sao.Wizard.Dialog=Sao.class_(Sao.Wizard,{init:function(a){a||(a="Wizard"),Sao.Wizard.Dialog._super.init.call(this),this.dialog=jQuery("<div/>",{"class":"wizard-dialog"}),this.dialog.dialog({dialogClass:"no-close",title:a,modal:!0,autoOpen:!1,closeOnEscape:!1,buttons:[{text:"dummy"}]}),this.dialog.append(this.widget),this.buttonset=this.dialog.parent().find(".ui-dialog-buttonset")},clean:function(){Sao.Wizard.Dialog._super.clean.call(this),this.buttonset.children().remove()},_get_button:function(a){var b=Sao.Wizard.Dialog._super._get_button.call(this,a);return this.buttonset.append(b.el),b.el.click(function(){this.response(a.state)}.bind(this)),b
},update:function(a,b,c){Sao.Wizard.Dialog._super.update.call(this,a,b,c),this.dialog.dialog("open")},destroy:function(){Sao.Wizard.Dialog._super.destroy.call(this),this.dialog.dialog("destroy")},end:function(){Sao.Wizard.Dialog._super.end.call(this),this.destroy()},show:function(){this.dialog.dialog("open")},hide:function(){this.dialog.dialog("close")},state_changed:function(){this.process()}})}();